<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>dyld中mach-o文件加载的简单分析 | mrh的学习分享</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="[TOC]
0x00 内容简介
 Les commencements ont des charmes inexprimables. 万物初始，美妙不可名状。

通过阅读dyld源码，简单的分析macho在dyld中是如何被加载到内存中的。">
<meta property="og:type" content="article">
<meta property="og:title" content="dyld中mach-o文件加载的简单分析">
<meta property="og:url" content="http://turingh.github.io/2016/03/01/dyld中macho加载的简单分析/index.html">
<meta property="og:site_name" content="mrh的学习分享">
<meta property="og:description" content="[TOC]
0x00 内容简介
 Les commencements ont des charmes inexprimables. 万物初始，美妙不可名状。

通过阅读dyld源码，简单的分析macho在dyld中是如何被加载到内存中的。">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/UMLClassDiagram-macho_header.png">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Butterfly-ImageLoader.png">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/instantiateMainExecutable.png">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Calls-instantiateFromLoadedImage.png">
<meta property="og:updated_time" content="2016-03-24T03:35:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dyld中mach-o文件加载的简单分析">
<meta name="twitter:description" content="[TOC]
0x00 内容简介
 Les commencements ont des charmes inexprimables. 万物初始，美妙不可名状。

通过阅读dyld源码，简单的分析macho在dyld中是如何被加载到内存中的。">
  
    <link rel="alternative" href="/atom.xml" title="mrh的学习分享" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/touxiang.jpeg">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">mrh</a></h1>
        </hgroup>

        
        <p class="header-subtitle">胸口写一个勇字</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">所有文章</a></li>
                        
                            <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                        
                            <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                            
                                <a class="fl twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                            
                                <a class="fl facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/CVE/" style="font-size: 18.33px;">CVE</a> <a href="/tags/DWORDSHOOT/" style="font-size: 10px;">DWORDSHOOT</a> <a href="/tags/IOS/" style="font-size: 10px;">IOS</a> <a href="/tags/OS-X/" style="font-size: 13.33px;">OS X</a> <a href="/tags/OSX/" style="font-size: 11.67px;">OSX</a> <a href="/tags/POC/" style="font-size: 11.67px;">POC</a> <a href="/tags/Pegasus/" style="font-size: 10px;">Pegasus</a> <a href="/tags/XNU/" style="font-size: 11.67px;">XNU</a> <a href="/tags/bounds-checking/" style="font-size: 10px;">bounds checking</a> <a href="/tags/dlopen/" style="font-size: 10px;">dlopen</a> <a href="/tags/dns/" style="font-size: 11.67px;">dns</a> <a href="/tags/dos/" style="font-size: 10px;">dos</a> <a href="/tags/dyld/" style="font-size: 16.67px;">dyld</a> <a href="/tags/dynamic-link/" style="font-size: 10px;">dynamic link</a> <a href="/tags/execv/" style="font-size: 13.33px;">execv</a> <a href="/tags/execve/" style="font-size: 10px;">execve</a> <a href="/tags/exploit/" style="font-size: 20px;">exploit</a> <a href="/tags/frame-faking/" style="font-size: 10px;">frame-faking</a> <a href="/tags/free/" style="font-size: 10px;">free</a> <a href="/tags/freebsd/" style="font-size: 10px;">freebsd</a> <a href="/tags/gethostbyname/" style="font-size: 11.67px;">gethostbyname</a> <a href="/tags/glibc/" style="font-size: 11.67px;">glibc</a> <a href="/tags/heap/" style="font-size: 16.67px;">heap</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/kextload/" style="font-size: 10px;">kextload</a> <a href="/tags/level02/" style="font-size: 10px;">level02</a> <a href="/tags/linux/" style="font-size: 11.67px;">linux</a> <a href="/tags/mach-o/" style="font-size: 20px;">mach-o</a> <a href="/tags/malloc/" style="font-size: 11.67px;">malloc</a> <a href="/tags/nano/" style="font-size: 10px;">nano</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/osx/" style="font-size: 16.67px;">osx</a> <a href="/tags/patch/" style="font-size: 10px;">patch</a> <a href="/tags/ports/" style="font-size: 13.33px;">ports</a> <a href="/tags/race/" style="font-size: 13.33px;">race</a> <a href="/tags/sandbox/" style="font-size: 10px;">sandbox</a> <a href="/tags/stack/" style="font-size: 13.33px;">stack</a> <a href="/tags/stackoverflow/" style="font-size: 11.67px;">stackoverflow</a> <a href="/tags/unlink/" style="font-size: 10px;">unlink</a> <a href="/tags/wargame/" style="font-size: 11.67px;">wargame</a> <a href="/tags/基本功要扎实/" style="font-size: 11.67px;">基本功要扎实</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">啥也不说了，先干黄旭东</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">mrh</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">mrh</a></h1>
            </hgroup>
            
            <p class="header-subtitle">胸口写一个勇字</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">所有文章</a></li>
                
                    <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                
                    <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                    
                        <a class="twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                    
                        <a class="facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-dyld中macho加载的简单分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/01/dyld中macho加载的简单分析/" class="article-date">
      <time datetime="2016-03-01T22:06:57.000Z" itemprop="datePublished">2016-03-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      dyld中mach-o文件加载的简单分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/OS-X/">OS X</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dyld/">dyld</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mach-o/">mach-o</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/osx/">osx</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>[TOC]</p>
<h1 id="0x00_内容简介">0x00 内容简介</h1><blockquote>
<p> Les commencements ont des charmes inexprimables.<br> 万物初始，美妙不可名状。</p>
</blockquote>
<p>通过阅读dyld源码，简单的分析macho在dyld中是如何被加载到内存中的。</p>
<a id="more"></a>
<h1 id="0x01_源码分析">0x01 源码分析</h1><p>mach-o的格式和ELF大同小异，具体分析网上可以搜到很多。就不复述了。</p>
<p><a href="https://samhuri.net/posts/2010/01/basics-of-the-mach-o-file-format" target="_blank" rel="external">Basics of the Mach-O file format</a></p>
<p><a href="http://opensource.apple.com/tarballs/dyld/dyld-360.18.tar.gz" target="_blank" rel="external">dyld源码下载</a></p>
<h1 id="1-1_数据结构">1.1 数据结构</h1><h3 id="1-1-1_macho_header">1.1.1 macho_header</h3><p>这个数据结构提供了对mach-o文件的头部做操作的API，函数都很简单不需要做过多的解释。</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/UMLClassDiagram-macho_header.png" alt="macho_header"></p>
<h2 id="1-1-2_ImageLoader">1.1.2  ImageLoader</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ImageLoader is an abstract base class.  To support loading a particular executable</span></span><br><span class="line"><span class="comment">// file format, you make a concrete subclass of ImageLoader.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For each executable file (dynamic shared object) in use, an ImageLoader is instantiated.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The ImageLoader base class does the work of linking together images, but it knows nothing</span></span><br><span class="line"><span class="comment">// about any particular file format.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">class</span>  &#123;ImageLoader</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个加载的mach-o文件都会存在这样一个<code>ImageLoader</code>的实例。具体代码太多参考<a href="http://opensource.apple.com/tarballs/dyld/dyld-360.18.tar.gz" target="_blank" rel="external">源码</a>。</p>
<p>每一种具体的mach-o文件都会继承<code>ImageLoader</code>类，大致继承关系如图所示：</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Butterfly-ImageLoader.png" alt="mageLoder"></p>
<p>在加载时会根据mach-o的格式不同选择不同的实例。</p>
<h2 id="1-2_源码分析">1.2 源码分析</h2><h3 id="1-2-1__main">1.2.1 _main</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Entry point for dyld.  The kernel loads dyld and jumps to __dyld_start which</span></span><br><span class="line"><span class="comment">// sets up some registers and call this function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns address of main() in target program which __dyld_start jumps to</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">uintptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide, </span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">  ... <span class="comment">//对全局变量一通操作</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">		addDyldImageToUUIDList();</span><br><span class="line">		CRSetCrashLogMessage(sLoadingCrashMessage);</span><br><span class="line">		<span class="comment">// instantiate ImageLoader for main executable</span></span><br><span class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);<span class="comment">//加载MACHO到image</span></span><br><span class="line">		... <span class="comment">//不关心了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调用<code>_main</code>函数之后，大致做了这么几件事情：</p>
<ul>
<li>选择运行环境(IOS模拟器)</li>
<li>初始化数据、设置全局变量，上下文信息</li>
<li>检测文件是否<code>Restricted</code></li>
</ul>
<p>走完这些流程，就会调用<code>instantiateFromLoadedImage</code>函数开始加载mach-o并实例化为<code>ImageLoader</code>。</p>
<h3 id="1-2-2_instantiateFromLoadedImage">1.2.2 instantiateFromLoadedImage</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The kernel maps in main executable before dyld gets control.  We need to </span></span><br><span class="line"><span class="comment">// make an ImageLoader* for the already mapped in main executable.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ImageLoader* <span class="title">instantiateFromLoadedImage</span><span class="params">(<span class="keyword">const</span> macho_header* mh, uintptr_t slide, <span class="keyword">const</span> <span class="keyword">char</span>* path)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// try mach-o loader</span></span><br><span class="line">	<span class="keyword">if</span> ( isCompatibleMachO((<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)mh, path) ) &#123;<span class="comment">//检测是否合法</span></span><br><span class="line">		ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext); <span class="comment">//加载</span></span><br><span class="line">		addImage(image);</span><br><span class="line">		<span class="keyword">return</span> image;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">throw</span> <span class="string">"main executable not a known format"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的逻辑非常的简单，总过做了三件事：</p>
<ul>
<li>检测macho文件是否符合条件</li>
<li>初始化实例</li>
<li>添加image到管理的模块中</li>
</ul>
<h3 id="1-2-3_isCompatibleMachO">1.2.3 isCompatibleMachO</h3><p>先看<code>isCompatibleMacho</code>函数。</p>
<p>通过注释可以知道，满足下面三个条件，即可认为是符合要求的mach-o文件。</p>
<ol>
<li><code>mach_header</code>中的<code>subtype</code>当前CPU版本是否支持。</li>
</ol>
<ol>
<li><p><code>mach_header</code>中的<code>subtype</code>和当前正在运行的CPU版本相同。</p>
</li>
<li><p><code>mach_header</code>中的<code>subtype</code>在该CPU的所有版本都可以处理。</p>
</li>
</ol>
<p>内核中<code>machine.h</code>定义了<code>CPU_TYPE</code>与<code>CPU_SUBTYPE</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_ANY		((cpu_type_t) -<span class="number">1</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_VAX		((cpu_type_t) <span class="number">1</span>)</span></span><br><span class="line"><span class="comment">/* skip				((cpu_type_t) 2)	*/</span></span><br><span class="line"><span class="comment">/* skip				((cpu_type_t) 3)	*/</span></span><br><span class="line"><span class="comment">/* skip				((cpu_type_t) 4)	*/</span></span><br><span class="line"><span class="comment">/* skip				((cpu_type_t) 5)	*/</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span>	CPU_TYPE_MC680x0	((cpu_type_t) <span class="number">6</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_X86		((cpu_type_t) <span class="number">7</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_I386		CPU_TYPE_X86		<span class="comment">/* compatibility */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span>	CPU_TYPE_X86_64		(CPU_TYPE_X86 | CPU_ARCH_ABI64)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* skip CPU_TYPE_MIPS		((cpu_type_t) 8)	*/</span></span><br><span class="line"><span class="comment">/* skip 			((cpu_type_t) 9)	*/</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_MC98000	((cpu_type_t) <span class="number">10</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_HPPA           ((cpu_type_t) <span class="number">11</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_ARM		((cpu_type_t) <span class="number">12</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_ARM64          (CPU_TYPE_ARM | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_MC88000	((cpu_type_t) <span class="number">13</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_SPARC		((cpu_type_t) <span class="number">14</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_I860		((cpu_type_t) <span class="number">15</span>)</span></span><br><span class="line"><span class="comment">/* skip	CPU_TYPE_ALPHA		((cpu_type_t) 16)	*/</span></span><br><span class="line"><span class="comment">/* skip				((cpu_type_t) 17)	*/</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_POWERPC		((cpu_type_t) <span class="number">18</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_TYPE_POWERPC64		(CPU_TYPE_POWERPC | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> *	Machine subtypes (these are defined here, instead of in a machine</span><br><span class="line"> *	dependent directory, so that any program can get all definitions</span><br><span class="line"> *	regardless of where is it compiled).</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Capability bits used in the definition of cpu_subtype.</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_MASK	<span class="number">0xff000000</span>	<span class="comment">/* mask for feature flags */</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_LIB64	<span class="number">0x80000000</span>	<span class="comment">/* 64 bit libraries */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> *	Object files that are hand-crafted to run on any</span><br><span class="line"> *	implementation of an architecture are tagged with</span><br><span class="line"> *	CPU_SUBTYPE_MULTIPLE.  This functions essentially the same as</span><br><span class="line"> *	the "ALL" subtype of an architecture except that it allows us</span><br><span class="line"> *	to easily find object files that may need to be modified</span><br><span class="line"> *	whenever a new implementation of an architecture comes out.</span><br><span class="line"> *</span><br><span class="line"> *	It is the responsibility of the implementor to make sure the</span><br><span class="line"> *	software handles unsupported implementations elegantly.</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span>	CPU_SUBTYPE_MULTIPLE		((cpu_subtype_t) -<span class="number">1</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_LITTLE_ENDIAN	((cpu_subtype_t) <span class="number">0</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_BIG_ENDIAN		((cpu_subtype_t) <span class="number">1</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> *     Machine threadtypes.</span><br><span class="line"> *     This is none - not defined - for most machine types/subtypes.</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_THREADTYPE_NONE		((cpu_threadtype_t) <span class="number">0</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> *	VAX subtypes (these do *not* necessary conform to the actual cpu</span><br><span class="line"> *	ID assigned by DEC available via the SID register).</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span>	CPU_SUBTYPE_VAX_ALL	((cpu_subtype_t) <span class="number">0</span>) </span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX780	((cpu_subtype_t) <span class="number">1</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX785	((cpu_subtype_t) <span class="number">2</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX750	((cpu_subtype_t) <span class="number">3</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX730	((cpu_subtype_t) <span class="number">4</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_UVAXI	((cpu_subtype_t) <span class="number">5</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_UVAXII	((cpu_subtype_t) <span class="number">6</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX8200	((cpu_subtype_t) <span class="number">7</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX8500	((cpu_subtype_t) <span class="number">8</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX8600	((cpu_subtype_t) <span class="number">9</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX8650	((cpu_subtype_t) <span class="number">10</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_VAX8800	((cpu_subtype_t) <span class="number">11</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> CPU_SUBTYPE_UVAXIII	((cpu_subtype_t) <span class="number">12</span>)</span></span><br></pre></td></tr></table></figure>
<p>简单的说<code>cputype</code>就是cpu的平台，<code>x86</code>、<code>ARM</code>、<code>PROWERPC</code>等。而<code>subtype</code>就是不同平台的不同版本，例如<code>arm6</code>、<code>arm7</code>。</p>
<p></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isCompatibleMachO</span><span class="params">(<span class="keyword">const</span> uint8_t* firstPage, <span class="keyword">const</span> <span class="keyword">char</span>* path)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CPU_SUBTYPES_SUPPORTED</span></span><br><span class="line">  	<span class="comment">// 支持检测CPU版本的情况</span></span><br><span class="line">	<span class="comment">// It is deemed compatible if any of the following are true:</span></span><br><span class="line">	<span class="comment">//  1) mach_header subtype is in list of compatible subtypes for running processor</span></span><br><span class="line">	<span class="comment">//  2) mach_header subtype is same as running processor subtype</span></span><br><span class="line">	<span class="comment">//  3) mach_header subtype runs on all processor variants</span></span><br><span class="line">	<span class="keyword">const</span> mach_header* mh = (mach_header*)firstPage;</span><br><span class="line">	<span class="keyword">if</span> ( mh-&gt;magic == sMainExecutableMachHeader-&gt;magic ) &#123; </span><br><span class="line">		<span class="comment">//传入的mach-o文件的magic是否和加载的主mach-o文件是否相同</span></span><br><span class="line">		<span class="comment">//这一次运行到这里的时候mh与sMainExecutableMacHeader应该是指向同一个mach-o的</span></span><br><span class="line">		<span class="keyword">if</span> ( mh-&gt;cputype == sMainExecutableMachHeader-&gt;cputype ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( (mh-&gt;cputype &amp; CPU_TYPE_MASK) == sHostCPU ) &#123;</span><br><span class="line">				<span class="comment">//加载的mh是否在当前平台可以运行。</span></span><br><span class="line">				<span class="comment">// get preference ordered list of subtypes that this machine can use</span></span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">cpu_subtype_t</span>* subTypePreferenceList = findCPUSubtypeList(mh-&gt;cputype, sHostCPUsubtype);</span><br><span class="line">				<span class="keyword">if</span> ( subTypePreferenceList != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">                  	  <span class="comment">//如果该CPU的版本存在一个检测的列表，则进行检测</span></span><br><span class="line">					<span class="comment">// if image's subtype is in the list, it is compatible</span></span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">cpu_subtype_t</span>* p = subTypePreferenceList; *p != CPU_SUBTYPE_END_OF_LIST; ++p) &#123;</span><br><span class="line">						<span class="keyword">if</span> ( *p == mh-&gt;cpusubtype )</span><br><span class="line">							<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// have list and not in list, so not compatible</span></span><br><span class="line">					throwf(<span class="string">"incompatible cpu-subtype: 0x%08X in %s"</span>, mh-&gt;cpusubtype, path);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// unknown cpu sub-type, but if exact match for current subtype then ok to use</span></span><br><span class="line">				<span class="keyword">if</span> ( mh-&gt;cpusubtype == sHostCPUsubtype ) </span><br><span class="line">                  	<span class="comment">//加载的mh与当前运行环境的CPU版本相同</span></span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// cpu type has no ordered list of subtypes</span></span><br><span class="line">             <span class="comment">// 这两种CPU支持所有版本的mach-o文件</span></span><br><span class="line">			<span class="keyword">switch</span> (mh-&gt;cputype) &#123;</span><br><span class="line">				<span class="keyword">case</span> CPU_TYPE_I386:</span><br><span class="line">				<span class="keyword">case</span> CPU_TYPE_X86_64:</span><br><span class="line">					<span class="comment">// subtypes are not used or these architectures</span></span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="comment">// For architectures that don't support cpu-sub-types</span></span><br><span class="line">	<span class="comment">// this just check the cpu type.</span></span><br><span class="line">  	<span class="comment">// 不支持检测CPU版本的时候，就只判断是mh的版本与CPU相同。</span></span><br><span class="line">	<span class="keyword">const</span> mach_header* mh = (mach_header*)firstPage;</span><br><span class="line">	<span class="keyword">if</span> ( mh-&gt;magic == sMainExecutableMachHeader-&gt;magic ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( mh-&gt;cputype == sMainExecutableMachHeader-&gt;cputype ) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-4_instantiateMainExecutable">1.2.4 instantiateMainExecutable</h3><p>函数流程主要是通过<code>sniffloadcommands</code>来判断mach-o文件是否是压缩过的，然后选择相应的类进行实例化。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create image for main executable</span></span><br><span class="line">ImageLoader* ImageLoaderMachO::instantiateMainExecutable(<span class="keyword">const</span> macho_header* mh, <span class="keyword">uintptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">const</span> LinkContext&amp; context)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//dyld::log("ImageLoader=%ld, ImageLoaderMachO=%ld, ImageLoaderMachOClassic=%ld, ImageLoaderMachOCompressed=%ld\n",</span></span><br><span class="line">	<span class="comment">//	sizeof(ImageLoader), sizeof(ImageLoaderMachO), sizeof(ImageLoaderMachOClassic), sizeof(ImageLoaderMachOCompressed));</span></span><br><span class="line">	<span class="keyword">bool</span> compressed;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> segCount;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> libCount;</span><br><span class="line">	<span class="keyword">const</span> linkedit_data_command* codeSigCmd;</span><br><span class="line">	<span class="keyword">const</span> encryption_info_command* encryptCmd;</span><br><span class="line">	sniffLoadCommands(mh, path, <span class="literal">false</span>, &amp;compressed, &amp;segCount, &amp;libCount, context, &amp;codeSigCmd, &amp;encryptCmd); <span class="comment">//判断macho是普通的还是压缩的</span></span><br><span class="line">	<span class="comment">// instantiate concrete class based on content of load commands</span></span><br><span class="line">	<span class="keyword">if</span> ( compressed ) </span><br><span class="line">		<span class="keyword">return</span> ImageLoaderMachOCompressed::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> SUPPORT_CLASSIC_MACHO</span></span><br><span class="line">		<span class="keyword">return</span> ImageLoaderMachOClassic::instantiateMainExecutable(mh, slide, path, segCount, libCount, context);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"missing LC_DYLD_INFO load command"</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的逻辑也非常简单。流程图如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/instantiateMainExecutable.png" alt="instantiateMainExecutable"></p>
<h3 id="1-2-5_sniffLoadCommands">1.2.5 sniffLoadCommands</h3><p>这个函数主要做了两件事情：</p>
<ul>
<li>判断Mach-O文件是<code>classic</code>的还是<code>compressed</code>的。</li>
<li>获取mach-O文件的<code>segment</code>的数量。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// determine if this mach-o file has classic or compressed LINKEDIT and number of segments it has</span></span><br><span class="line"><span class="keyword">void</span> ImageLoaderMachO::sniffLoadCommands(<span class="keyword">const</span> macho_header* mh, <span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">bool</span> inCache, <span class="keyword">bool</span>* compressed,</span><br><span class="line">											<span class="keyword">unsigned</span> <span class="keyword">int</span>* segCount, <span class="keyword">unsigned</span> <span class="keyword">int</span>* libCount, <span class="keyword">const</span> LinkContext&amp; context,</span><br><span class="line">											<span class="keyword">const</span> linkedit_data_command** codeSigCmd,</span><br><span class="line">											<span class="keyword">const</span> encryption_info_command** encryptCmd)</span><br><span class="line">&#123;</span><br><span class="line">	*compressed = <span class="literal">false</span>;</span><br><span class="line">	*segCount = <span class="number">0</span>;</span><br><span class="line">	*libCount = <span class="number">0</span>;</span><br><span class="line">	*codeSigCmd = <span class="literal">NULL</span>;</span><br><span class="line">	*encryptCmd = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">uint32_t</span> cmd_count = mh-&gt;ncmds;</span><br><span class="line">	<span class="comment">//获取cmds的个数,保存在mach-o文件的头部ncmds字段中</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">struct</span> load_command* <span class="keyword">const</span> startCmds    = (<span class="keyword">struct</span> load_command*)(((<span class="keyword">uint8_t</span>*)mh) + <span class="keyword">sizeof</span>(macho_header));</span><br><span class="line">	<span class="comment">//获取command段开始的地址，startCmds = mach-o地址 + mach-o头部长度</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">struct</span> load_command* <span class="keyword">const</span> endCmds = (<span class="keyword">struct</span> load_command*)(((<span class="keyword">uint8_t</span>*)mh) + <span class="keyword">sizeof</span>(macho_header) + mh-&gt;sizeofcmds);</span><br><span class="line">	<span class="comment">//获取command段结束的地址，endCmds = mach-o地址 + mach-o头部长度 + cmds所用的长度</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">struct</span> load_command* cmd = startCmds;</span><br><span class="line">	<span class="keyword">bool</span> foundLoadCommandSegment = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; cmd_count; ++i) &#123;</span><br><span class="line">		<span class="comment">//遍历每一个command</span></span><br><span class="line">		<span class="keyword">uint32_t</span> cmdLength = cmd-&gt;cmdsize;</span><br><span class="line">		<span class="keyword">struct</span> macho_segment_command* segCmd;</span><br><span class="line">		<span class="keyword">if</span> ( cmdLength &lt; <span class="number">8</span> ) &#123;</span><br><span class="line">			<span class="comment">//格式检测：长度就不对抛出异常</span></span><br><span class="line">			dyld::throwf(<span class="string">"malformed mach-o image: load command #%d length (%u) too small in %s"</span>,</span><br><span class="line">											   i, cmdLength, path);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">struct</span> load_command* <span class="keyword">const</span> nextCmd = (<span class="keyword">const</span> <span class="keyword">struct</span> load_command*)(((<span class="keyword">char</span>*)cmd)+cmdLength);</span><br><span class="line">		<span class="keyword">if</span> ( (nextCmd &gt; endCmds) || (nextCmd &lt; cmd) ) &#123;</span><br><span class="line">			<span class="comment">//格式检测：通过当前command长度寻找nextcmd时，如果nextcmd指不合法的位置就抛出异常</span></span><br><span class="line">			dyld::throwf(<span class="string">"malformed mach-o image: load command #%d length (%u) would exceed sizeofcmds (%u) in %s"</span>,</span><br><span class="line">											   i, cmdLength, mh-&gt;sizeofcmds, path);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> (cmd-&gt;cmd) &#123;</span><br><span class="line">			<span class="comment">//针对每种类型的command做不同的操作</span></span><br><span class="line">			<span class="keyword">case</span> LC_DYLD_INFO:</span><br><span class="line">			<span class="keyword">case</span> LC_DYLD_INFO_ONLY:</span><br><span class="line">				*compressed = <span class="literal">true</span>;</span><br><span class="line">				<span class="comment">//mach-o文件为压缩的mach-o文件</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> LC_SEGMENT_COMMAND:</span><br><span class="line">				segCmd = (<span class="keyword">struct</span> macho_segment_command*)cmd;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class="line">				<span class="comment">// rdar://problem/19617624 allow unmapped segments on OSX (but not iOS)</span></span><br><span class="line">				<span class="comment">// 如果segCmd的文件长度大于segCmd的vmszie，抛出异常。</span></span><br><span class="line">				<span class="comment">// <span class="doctag">todo:</span>结合mach-o文件加载内核部分再详细解释</span></span><br><span class="line">				<span class="keyword">if</span> ( (segCmd-&gt;filesize &gt; segCmd-&gt;vmsize) &amp;&amp; (segCmd-&gt;vmsize != <span class="number">0</span>) )</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">				<span class="keyword">if</span> ( segCmd-&gt;filesize &gt; segCmd-&gt;vmsize )</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">				    dyld::throwf(<span class="string">"malformed mach-o image: segment load command %s filesize is larger than vmsize"</span>, segCmd-&gt;segname);</span><br><span class="line">				<span class="comment">// ignore zero-sized segments</span></span><br><span class="line">				<span class="comment">// 忽略长度为0的segments，计算segments的个数</span></span><br><span class="line">				<span class="keyword">if</span> ( segCmd-&gt;vmsize != <span class="number">0</span> )</span><br><span class="line">					*segCount += <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">if</span> ( context.codeSigningEnforced ) &#123;</span><br><span class="line">					<span class="comment">//如果有强制代码签名，则需要更加严格的segments格式合法性检测。</span></span><br><span class="line">					<span class="keyword">uintptr_t</span> vmStart   = segCmd-&gt;vmaddr;</span><br><span class="line">					<span class="keyword">uintptr_t</span> vmSize    = segCmd-&gt;vmsize;</span><br><span class="line">					<span class="keyword">uintptr_t</span> vmEnd     = vmStart + vmSize;</span><br><span class="line">					<span class="keyword">uintptr_t</span> fileStart = segCmd-&gt;fileoff;</span><br><span class="line">					<span class="keyword">uintptr_t</span> fileSize  = segCmd-&gt;filesize;</span><br><span class="line">					</span><br><span class="line">					<span class="comment">//对参数做合法性检测，如果mach-o文件不合法则抛出异常</span></span><br><span class="line">					<span class="keyword">if</span> ( (<span class="keyword">intptr_t</span>)(vmEnd) &lt; <span class="number">0</span>)</span><br><span class="line">						dyld::throwf(<span class="string">"malformed mach-o image: segment load command %s vmsize too large"</span>, segCmd-&gt;segname);</span><br><span class="line">					<span class="keyword">if</span> ( vmStart &gt; vmEnd )</span><br><span class="line">						dyld::throwf(<span class="string">"malformed mach-o image: segment load command %s wraps around address space"</span>, segCmd-&gt;segname);</span><br><span class="line">					<span class="keyword">if</span> ( vmSize != fileSize ) &#123;</span><br><span class="line">						<span class="keyword">if</span> ( (segCmd-&gt;initprot == <span class="number">0</span>) &amp;&amp; (fileSize != <span class="number">0</span>) )</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: unaccessable segment %s has filesize != 0"</span>, segCmd-&gt;segname);</span><br><span class="line">						<span class="keyword">else</span> <span class="keyword">if</span> ( vmSize &lt; fileSize )</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: segment %s has vmsize &lt; filesize"</span>, segCmd-&gt;segname);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> ( inCache ) &#123;</span><br><span class="line">						<span class="keyword">if</span> ( (fileSize != <span class="number">0</span>) &amp;&amp; (segCmd-&gt;initprot == (VM_PROT_READ | VM_PROT_EXECUTE)) ) &#123;</span><br><span class="line">							<span class="keyword">if</span> ( foundLoadCommandSegment )</span><br><span class="line">								<span class="keyword">throw</span> <span class="string">"load commands in multiple segments"</span>;</span><br><span class="line">							foundLoadCommandSegment = <span class="literal">true</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> ( (fileStart &lt; mh-&gt;sizeofcmds) &amp;&amp; (fileSize != <span class="number">0</span>) ) &#123;</span><br><span class="line">						<span class="comment">// &lt;rdar://problem/7942521&gt; all load commands must be in an executable segment</span></span><br><span class="line">						<span class="keyword">if</span> ( (fileStart != <span class="number">0</span>) || (fileSize &lt; (mh-&gt;sizeofcmds+<span class="keyword">sizeof</span>(macho_header))) )</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: segment %s does not span all load commands"</span>, segCmd-&gt;segname); </span><br><span class="line">						<span class="keyword">if</span> ( segCmd-&gt;initprot != (VM_PROT_READ | VM_PROT_EXECUTE) ) </span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: load commands found in segment %s with wrong permissions"</span>, segCmd-&gt;segname); </span><br><span class="line">						<span class="keyword">if</span> ( foundLoadCommandSegment )</span><br><span class="line">							<span class="keyword">throw</span> <span class="string">"load commands in multiple segments"</span>;</span><br><span class="line">						foundLoadCommandSegment = <span class="literal">true</span>;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">const</span> <span class="keyword">struct</span> macho_section* <span class="keyword">const</span> sectionsStart = (<span class="keyword">struct</span> macho_section*)((<span class="keyword">char</span>*)segCmd + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> macho_segment_command));</span><br><span class="line">					<span class="keyword">const</span> <span class="keyword">struct</span> macho_section* <span class="keyword">const</span> sectionsEnd = &amp;sectionsStart[segCmd-&gt;nsects];</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">struct</span> macho_section* sect=sectionsStart; sect &lt; sectionsEnd; ++sect) &#123;</span><br><span class="line">						<span class="keyword">if</span> (!inCache &amp;&amp; sect-&gt;offset != <span class="number">0</span> &amp;&amp; ((sect-&gt;offset + sect-&gt;size) &gt; (segCmd-&gt;fileoff + segCmd-&gt;filesize)))</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: section %s,%s of '%s' exceeds segment %s booundary"</span>, sect-&gt;segname, sect-&gt;sectname, path, segCmd-&gt;segname);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> LC_SEGMENT_COMMAND_WRONG:</span><br><span class="line">				dyld::throwf(<span class="string">"malformed mach-o image: wrong LC_SEGMENT[_64] for architecture"</span>); </span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> LC_LOAD_DYLIB:</span><br><span class="line">			<span class="keyword">case</span> LC_LOAD_WEAK_DYLIB:</span><br><span class="line">			<span class="keyword">case</span> LC_REEXPORT_DYLIB:</span><br><span class="line">			<span class="keyword">case</span> LC_LOAD_UPWARD_DYLIB:</span><br><span class="line">				*libCount += <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> LC_CODE_SIGNATURE:</span><br><span class="line">				*codeSigCmd = (<span class="keyword">struct</span> linkedit_data_command*)cmd; <span class="comment">// only support one LC_CODE_SIGNATURE per image</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO:</span><br><span class="line">			<span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</span><br><span class="line">				*encryptCmd = (<span class="keyword">struct</span> encryption_info_command*)cmd; <span class="comment">// only support one LC_ENCRYPTION_INFO[_64] per image</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		cmd = nextCmd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( context.codeSigningEnforced &amp;&amp; !foundLoadCommandSegment )</span><br><span class="line">		<span class="keyword">throw</span> <span class="string">"load commands not in a segment"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/13145644&gt; verify every segment does not overlap another segment</span></span><br><span class="line">	<span class="keyword">if</span> ( context.codeSigningEnforced ) &#123;</span><br><span class="line">		<span class="comment">//如果设置了强制代码签名，则需要更加严格的检测，确认segments没有互相覆盖。</span></span><br><span class="line">		<span class="keyword">uintptr_t</span> lastFileStart = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">uintptr_t</span> linkeditFileStart = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">struct</span> load_command* cmd1 = startCmds;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; cmd_count; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( cmd1-&gt;cmd == LC_SEGMENT_COMMAND ) &#123;</span><br><span class="line">				<span class="keyword">struct</span> macho_segment_command* segCmd1 = (<span class="keyword">struct</span> macho_segment_command*)cmd1;</span><br><span class="line">				<span class="keyword">uintptr_t</span> vmStart1   = segCmd1-&gt;vmaddr;</span><br><span class="line">				<span class="keyword">uintptr_t</span> vmEnd1     = segCmd1-&gt;vmaddr + segCmd1-&gt;vmsize;</span><br><span class="line">				<span class="keyword">uintptr_t</span> fileStart1 = segCmd1-&gt;fileoff;</span><br><span class="line">				<span class="keyword">uintptr_t</span> fileEnd1   = segCmd1-&gt;fileoff + segCmd1-&gt;filesize;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (fileStart1 &gt; lastFileStart)</span><br><span class="line">					lastFileStart = fileStart1;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;segCmd1-&gt;segname[<span class="number">0</span>], <span class="string">"__LINKEDIT"</span>) == <span class="number">0</span> ) &#123;</span><br><span class="line">					linkeditFileStart = fileStart1;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">struct</span> load_command* cmd2 = startCmds;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">uint32_t</span> j = <span class="number">0</span>; j &lt; cmd_count; ++j) &#123;</span><br><span class="line">					<span class="keyword">if</span> ( cmd2 == cmd1 )</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					<span class="keyword">if</span> ( cmd2-&gt;cmd == LC_SEGMENT_COMMAND ) &#123;</span><br><span class="line">						<span class="keyword">struct</span> macho_segment_command* segCmd2 = (<span class="keyword">struct</span> macho_segment_command*)cmd2;</span><br><span class="line">						<span class="keyword">uintptr_t</span> vmStart2   = segCmd2-&gt;vmaddr;</span><br><span class="line">						<span class="keyword">uintptr_t</span> vmEnd2     = segCmd2-&gt;vmaddr + segCmd2-&gt;vmsize;</span><br><span class="line">						<span class="keyword">uintptr_t</span> fileStart2 = segCmd2-&gt;fileoff;</span><br><span class="line">						<span class="keyword">uintptr_t</span> fileEnd2   = segCmd2-&gt;fileoff + segCmd2-&gt;filesize;</span><br><span class="line">						<span class="keyword">if</span> ( ((vmStart2 &lt;= vmStart1) &amp;&amp; (vmEnd2 &gt; vmStart1) &amp;&amp; (vmEnd1 &gt; vmStart1)) </span><br><span class="line">						|| ((vmStart2 &gt;= vmStart1) &amp;&amp; (vmStart2 &lt; vmEnd1) &amp;&amp; (vmEnd2 &gt; vmStart2)) )</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: segment %s vm overlaps segment %s"</span>, segCmd1-&gt;segname, segCmd2-&gt;segname);</span><br><span class="line">						<span class="keyword">if</span> ( ((fileStart2 &lt;= fileStart1) &amp;&amp; (fileEnd2 &gt; fileStart1) &amp;&amp; (fileEnd1 &gt; fileStart1))</span><br><span class="line">						  || ((fileStart2 &gt;= fileStart1) &amp;&amp; (fileStart2 &lt; fileEnd1) &amp;&amp; (fileEnd2 &gt; fileStart2)) )</span><br><span class="line">							dyld::throwf(<span class="string">"malformed mach-o image: segment %s file content overlaps segment %s"</span>, segCmd1-&gt;segname, segCmd2-&gt;segname); </span><br><span class="line">					&#125;</span><br><span class="line">					cmd2 = (<span class="keyword">const</span> <span class="keyword">struct</span> load_command*)(((<span class="keyword">char</span>*)cmd2)+cmd2-&gt;cmdsize);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cmd1 = (<span class="keyword">const</span> <span class="keyword">struct</span> load_command*)(((<span class="keyword">char</span>*)cmd1)+cmd1-&gt;cmdsize);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (lastFileStart != linkeditFileStart)</span><br><span class="line">			dyld::throwf(<span class="string">"malformed mach-o image: __LINKEDIT must be last segment"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fSegmentsArrayCount is only 8-bits</span></span><br><span class="line">	<span class="keyword">if</span> ( *segCount &gt; <span class="number">255</span> )</span><br><span class="line">		dyld::throwf(<span class="string">"malformed mach-o image: more than 255 segments in %s"</span>, path);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fSegmentsArrayCount is only 8-bits</span></span><br><span class="line">	<span class="keyword">if</span> ( *libCount &gt; <span class="number">4095</span> )</span><br><span class="line">		dyld::throwf(<span class="string">"malformed mach-o image: more than 4095 dependent libraries in %s"</span>, path);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( needsAddedLibSystemDepency(*libCount, mh) )</span><br><span class="line">		*libCount = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-5_instantiateMainExecutable">1.2.5 instantiateMainExecutable</h3><p>classic与compressed的初始化大同小异，先看一下Classic的初始化函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create image for main executable</span></span><br><span class="line">ImageLoaderMachOClassic* ImageLoaderMachOClassic::instantiateMainExecutable(<span class="keyword">const</span> macho_header* mh, <span class="keyword">uintptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">char</span>* path, </span><br><span class="line">																		<span class="keyword">unsigned</span> <span class="keyword">int</span> segCount, <span class="keyword">unsigned</span> <span class="keyword">int</span> libCount, <span class="keyword">const</span> LinkContext&amp; context)</span><br><span class="line">&#123;</span><br><span class="line">	ImageLoaderMachOClassic* image = ImageLoaderMachOClassic::instantiateStart(mh, path, segCount, libCount);</span><br><span class="line">	<span class="comment">//实例化image</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//为PIE设置所需的参数，Position Independent Executables</span></span><br><span class="line">	<span class="comment">//<span class="doctag">todo:</span>分析了解PIE</span></span><br><span class="line">	<span class="comment">// set slide for PIE programs</span></span><br><span class="line">	image-&gt;setSlide(slide);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// for PIE record end of program, to know where to start loading dylibs</span></span><br><span class="line">	<span class="keyword">if</span> ( slide != <span class="number">0</span> )</span><br><span class="line">		fgNextPIEDylibAddress = (<span class="keyword">uintptr_t</span>)image-&gt;getEnd();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置一堆参数</span></span><br><span class="line">	image-&gt;disableCoverageCheck();</span><br><span class="line">	image-&gt;instantiateFinish(context);</span><br><span class="line">	image-&gt;setMapped(context);</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __i386__</span></span><br><span class="line">	<span class="comment">// kernel may have mapped in __IMPORT segment read-only, we need it read/write to do binding</span></span><br><span class="line">	<span class="keyword">if</span> ( image-&gt;fReadOnlyImportSegment ) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; image-&gt;fSegmentsCount; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( image-&gt;segIsReadOnlyImport(i) )</span><br><span class="line">				image-&gt;segMakeWritable(i, context);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//如果设置了context.verboseMapping，打印详细的LOG</span></span><br><span class="line">	<span class="keyword">if</span> ( context.verboseMapping ) &#123;</span><br><span class="line">		dyld::<span class="built_in">log</span>(<span class="string">"dyld: Main executable mapped %s\n"</span>, path);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>, e=image-&gt;segmentCount(); i &lt; e; ++i) &#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span>* name = image-&gt;segName(i);</span><br><span class="line">			<span class="keyword">if</span> ( (<span class="built_in">strcmp</span>(name, <span class="string">"__PAGEZERO"</span>) == <span class="number">0</span>) || (<span class="built_in">strcmp</span>(name, <span class="string">"__UNIXSTACK"</span>) == <span class="number">0</span>)  )</span><br><span class="line">				dyld::<span class="built_in">log</span>(<span class="string">"%18s at 0x%08lX-&gt;0x%08lX\n"</span>, name, image-&gt;segPreferredLoadAddress(i), image-&gt;segPreferredLoadAddress(i)+image-&gt;segSize(i));</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				dyld::<span class="built_in">log</span>(<span class="string">"%18s at 0x%08lX-&gt;0x%08lX\n"</span>, name, image-&gt;segActualLoadAddress(i), image-&gt;segActualEndAddress(i));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到加载的核心代码还在<code>ImageLoaderMachOClassic::instantiateStart</code>函数中。</p>
<h3 id="1-2-6_instantiateStart">1.2.6 instantiateStart</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// construct ImageLoaderMachOClassic using "placement new" with SegmentMachO objects array at end</span><br><span class="line">ImageLoaderMachOClassic* ImageLoaderMachOClassic::instantiateStart(const macho_header* mh, const char* path,</span><br><span class="line">																		unsigned int segCount, unsigned int libCount)</span><br><span class="line">&#123;</span><br><span class="line">	size_t size = sizeof(ImageLoaderMachOClassic) + segCount * sizeof(uint32_t) + libCount * sizeof(ImageLoader*);</span><br><span class="line">	ImageLoaderMachOClassic* allocatedSpace = static_cast&lt;ImageLoaderMachOClassic*&gt;(malloc(size));</span><br><span class="line">	if ( allocatedSpace == NULL )</span><br><span class="line">		throw "malloc failed";</span><br><span class="line">	uint32_t* segOffsets = ((uint32_t*)(((uint8_t*)allocatedSpace) + sizeof(ImageLoaderMachOClassic)));</span><br><span class="line">	bzero(&amp;segOffsets[segCount], libCount*sizeof(void*));	// zero out lib array</span><br><span class="line">	return new (allocatedSpace) ImageLoaderMachOClassic(mh, path, segCount, segOffsets, libCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里仍然没有出现加载核心代码，只是根据之前获得的数据申请了内存，并计算了segments的指针。而</p>
<p><code>ImageLoaderMachOClassic</code>的构造才是加载逻辑。</p>
<h3 id="1-2-7_ImageLoaderMachO">1.2.7 ImageLoaderMachO</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ImageLoaderMachOClassic::ImageLoaderMachOClassic(<span class="keyword">const</span> macho_header* mh, <span class="keyword">const</span> <span class="keyword">char</span>* path, </span><br><span class="line">													<span class="keyword">unsigned</span> <span class="keyword">int</span> segCount, <span class="keyword">uint32_t</span> segOffsets[], <span class="keyword">unsigned</span> <span class="keyword">int</span> libCount)</span><br><span class="line"> : ImageLoaderMachO(mh, path, segCount, segOffsets, libCount), fStrings(<span class="literal">NULL</span>), fSymbolTable(<span class="literal">NULL</span>), fDynamicInfo(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ImageLoaderMachO::ImageLoaderMachO(<span class="keyword">const</span> macho_header* mh, <span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">unsigned</span> <span class="keyword">int</span> segCount, </span><br><span class="line">																<span class="keyword">uint32_t</span> segOffsets[], <span class="keyword">unsigned</span> <span class="keyword">int</span> libCount)</span><br><span class="line"> : ImageLoader(path, libCount), fCoveredCodeLength(<span class="number">0</span>), fMachOData((<span class="keyword">uint8_t</span>*)mh), fLinkEditBase(<span class="literal">NULL</span>), fSlide(<span class="number">0</span>),</span><br><span class="line">	fEHFrameSectionOffset(<span class="number">0</span>), fUnwindInfoSectionOffset(<span class="number">0</span>), fDylibIDOffset(<span class="number">0</span>), </span><br><span class="line">fSegmentsCount(segCount), fIsSplitSeg(<span class="literal">false</span>), fInSharedCache(<span class="literal">false</span>),</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> TEXT_RELOC_SUPPORT</span></span><br><span class="line">	fTextSegmentRebases(<span class="literal">false</span>),</span><br><span class="line">	fTextSegmentBinds(<span class="literal">false</span>),</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __i386__</span></span><br><span class="line">	fReadOnlyImportSegment(<span class="literal">false</span>),</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	fHasSubLibraries(<span class="literal">false</span>), fHasSubUmbrella(<span class="literal">false</span>), fInUmbrella(<span class="literal">false</span>), fHasDOFSections(<span class="literal">false</span>), fHasDashInit(<span class="literal">false</span>),</span><br><span class="line">	fHasInitializers(<span class="literal">false</span>), fHasTerminators(<span class="literal">false</span>), fRegisteredAsRequiresCoalescing(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">	fIsSplitSeg = ((mh-&gt;flags &amp; MH_SPLIT_SEGS) != <span class="number">0</span>);        </span><br><span class="line"></span><br><span class="line">	<span class="comment">// construct SegmentMachO object for each LC_SEGMENT cmd using "placement new" to put </span></span><br><span class="line">	<span class="comment">// each SegmentMachO object in array at end of ImageLoaderMachO object</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">uint32_t</span> cmd_count = mh-&gt;ncmds;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">struct</span> load_command* <span class="keyword">const</span> cmds = (<span class="keyword">struct</span> load_command*)&amp;fMachOData[<span class="keyword">sizeof</span>(macho_header)];</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">struct</span> load_command* cmd = cmds;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>, segIndex=<span class="number">0</span>; i &lt; cmd_count; ++i) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( cmd-&gt;cmd == LC_SEGMENT_COMMAND ) &#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">struct</span> macho_segment_command* segCmd = (<span class="keyword">struct</span> macho_segment_command*)cmd;</span><br><span class="line">			<span class="comment">// ignore zero-sized segments</span></span><br><span class="line">			<span class="keyword">if</span> ( segCmd-&gt;vmsize != <span class="number">0</span> ) &#123;</span><br><span class="line">				<span class="comment">// record offset of load command</span></span><br><span class="line">				segOffsets[segIndex++] = (<span class="keyword">uint32_t</span>)((<span class="keyword">uint8_t</span>*)segCmd - fMachOData);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		cmd = (<span class="keyword">const</span> <span class="keyword">struct</span> load_command*)(((<span class="keyword">char</span>*)cmd)+cmd-&gt;cmdsize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里也没有什么复杂的代码了，就是根据<code>mach-o</code>文件<code>segments</code>的规则将数据加载到内存中。</p>
<p>这边返回之后就剩下调用<code>addimage</code>函数了。</p>
<h3 id="1-2-7_addimage">1.2.7 addimage</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addImage</span><span class="params">(ImageLoader* image)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// add to master list</span></span><br><span class="line">	<span class="comment">// 对所有images的容器原子添加image</span></span><br><span class="line">    allImagesLock();</span><br><span class="line">        sAllImages.push_back(image);</span><br><span class="line">    allImagesUnlock();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// update mapped ranges</span></span><br><span class="line">	<span class="comment">// 更新内存分布的数据</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> lastSegStart = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">uintptr_t</span> lastSegEnd = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>, e=image-&gt;segmentCount(); i &lt; e; ++i) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( image-&gt;segUnaccessible(i) ) </span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">uintptr_t</span> start = image-&gt;segActualLoadAddress(i);</span><br><span class="line">		<span class="keyword">uintptr_t</span> end = image-&gt;segActualEndAddress(i);</span><br><span class="line">		<span class="keyword">if</span> ( start == lastSegEnd ) &#123;</span><br><span class="line">			<span class="comment">// two segments are contiguous, just record combined segments</span></span><br><span class="line">			lastSegEnd = end;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// non-contiguous segments, record last (if any)</span></span><br><span class="line">			<span class="keyword">if</span> ( lastSegEnd != <span class="number">0</span> )</span><br><span class="line">				addMappedRange(image, lastSegStart, lastSegEnd);</span><br><span class="line">			lastSegStart = start;</span><br><span class="line">			lastSegEnd = end;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( lastSegEnd != <span class="number">0</span> )</span><br><span class="line">		addMappedRange(image, lastSegStart, lastSegEnd);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_LIBRARIES || (sEnv.DYLD_PRINT_LIBRARIES_POST_LAUNCH &amp;&amp; (sMainExecutable!=<span class="literal">NULL</span>) &amp;&amp; sMainExecutable-&gt;isLinked()) ) &#123;</span><br><span class="line">		dyld::<span class="built_in">log</span>(<span class="string">"dyld: loaded: %s\n"</span>, image-&gt;getPath());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addimage也只是做了一些数据更新</p>
<ul>
<li>将image添加到管理容器中</li>
<li>更新了内存分布的信息</li>
</ul>
<h1 id="0x02_小结">0x02 小结</h1><p>整个加载过程基本分为三个部分</p>
<ul>
<li>数据合法检测</li>
<li>根据mach-o文件的头部信息,将segments的具体信息构建到image的实例中</li>
<li>添加image到管理容器</li>
</ul>
<p>重要的几个函数如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/dyld_macho_load/Calls-instantiateFromLoadedImage.png" alt="重要函数"></p>
<p>​    </p>
<p>那么mach-o文件的加载流程更多的细节就需要通过分析xnu内核了。</p>
<h1 id="reference">reference</h1><p>1.对dyld的分析(源码.代码签名等) </p>
<p><a href="http://cocoahuke.com/2016/02/14/dyld%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/" target="_blank" rel="external">http://cocoahuke.com/2016/02/14/dyld%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/</a></p>
<p>2.mach-o文件加载的全过程(1)</p>
<p><a href="http://dongaxis.github.io/2015/01/01/mac-o%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B-1/" target="_blank" rel="external">http://dongaxis.github.io/2015/01/01/mac-o%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B-1/</a></p>
<p>PS：</p>
<p>更多文章可以在我的学习分享博客<a href="http://BLOGIMAGE/找到，希望可以多多交流，不足之处还希望大家可以给与指正：）" target="_blank" rel="external">http://BLOGIMAGE/找到，希望可以多多交流，不足之处还希望大家可以给与指正：）</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/03/01/dyld中macho加载的简单分析/">dyld中mach-o文件加载的简单分析</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 mrh 的个人博客">mrh</a></p>
        <p><span>发布时间:</span>2016年03月01日 - 17时06分</p>
        <p><span>最后更新:</span>2016年03月23日 - 23时35分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/03/01/dyld中macho加载的简单分析/" title="dyld中mach-o文件加载的简单分析">http://turingh.github.io/2016/03/01/dyld中macho加载的简单分析/</a>
            <span class="copy-path" data-clipboard-text="原文: http://turingh.github.io/2016/03/01/dyld中macho加载的简单分析/　　作者: mrh" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2016/03/03/CVE-2016-0799简单分析/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          CVE-2016-0799简单分析
        
      </div>
    </a>
  
  
    <a href="/2016/02/29/OS-X-内核研究-基础知识/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">OS X 内核研究 准备知识</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00_内容简介"><span class="toc-number">1.</span> <span class="toc-text">0x00 内容简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01_源码分析"><span class="toc-number">2.</span> <span class="toc-text">0x01 源码分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-1_数据结构"><span class="toc-number">3.</span> <span class="toc-text">1.1 数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1_macho_header"><span class="toc-number">3.0.1.</span> <span class="toc-text">1.1.1 macho_header</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-2_ImageLoader"><span class="toc-number">3.1.</span> <span class="toc-text">1.1.2  ImageLoader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2_源码分析"><span class="toc-number">3.2.</span> <span class="toc-text">1.2 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1__main"><span class="toc-number">3.2.1.</span> <span class="toc-text">1.2.1 _main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2_instantiateFromLoadedImage"><span class="toc-number">3.2.2.</span> <span class="toc-text">1.2.2 instantiateFromLoadedImage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3_isCompatibleMachO"><span class="toc-number">3.2.3.</span> <span class="toc-text">1.2.3 isCompatibleMachO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-4_instantiateMainExecutable"><span class="toc-number">3.2.4.</span> <span class="toc-text">1.2.4 instantiateMainExecutable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-5_sniffLoadCommands"><span class="toc-number">3.2.5.</span> <span class="toc-text">1.2.5 sniffLoadCommands</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-5_instantiateMainExecutable"><span class="toc-number">3.2.6.</span> <span class="toc-text">1.2.5 instantiateMainExecutable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-6_instantiateStart"><span class="toc-number">3.2.7.</span> <span class="toc-text">1.2.6 instantiateStart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-7_ImageLoaderMachO"><span class="toc-number">3.2.8.</span> <span class="toc-text">1.2.7 ImageLoaderMachO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-7_addimage"><span class="toc-number">3.2.9.</span> <span class="toc-text">1.2.7 addimage</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02_小结"><span class="toc-number">4.</span> <span class="toc-text">0x02 小结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number">5.</span> <span class="toc-text">reference</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>







    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/03/03/CVE-2016-0799简单分析/" title="上一篇: CVE-2016-0799简单分析">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2016/02/29/OS-X-内核研究-基础知识/" title="下一篇: OS X 内核研究 准备知识">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/28/task-t-considered-harmfull-analysis-P1/">XNU内核中task_t相关漏洞分析笔记(Part I)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/07/CVE-2016-4656分析与调试/">CVE-2016-4656分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/再看CVE-2016-1757浅析mach message的使用/">再看CVE-2016-1757---浅析mach message的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/libmalloc源码分析之nanozone-s的处理/">libmalloc源码分析之nanozone_s的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/libmalloc源码分析之初始化/">libmalloc源码分析之初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/nlist-Mach-O文件重定向信息数据结构分析/">nlist-Mach-O文件重定向信息数据结构分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/10-11-4版本小结/">10-11-4版本小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/29/CVE-2016-1749内核代码执行POC分析/">CVE-2016-1749内核代码执行POC分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/CVE-2016-1757利用程序分析/">CVE-2016-1757利用程序分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/18/apple沙盒研究之基础知识/">apple沙盒研究之基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/13/利用patch绕过kextload对内核签名的检测/">利用patch绕过kextload对内核签名的检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/CVE-2016-1757简单分析/">CVE-2016-1757简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/30/OSX内核加载mach-o流程分析/">OSX内核加载mach-o流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/fishhook源码分析/">fishhook源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/dyld源码分析load/">dyld源码分析-动态加载load</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/10/Mach-O的动态链接/">Mach-O的动态链接相关知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/mach-o文件格式分析/">mach-o格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/03/CVE-2016-0799简单分析/">CVE-2016-0799简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/dyld中macho加载的简单分析/">dyld中mach-o文件加载的简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/29/OS-X-内核研究-基础知识/">OS X 内核研究 准备知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/通过fusion level02浅谈exploit中的函数调用伪造/">通过fusion level02浅谈exploit中的函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试副本/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/09/CVE-2016-1879调试&分析/">CVE-2016-1879 调试&分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/27/frame-faking/">frame-faking-介绍-函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/protostar-heap3/">protostar详细解析 heap3-通过heap3理解堆腐坏的原理及利用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/12/图解DWORDSHOOT/">图解DWORDSHOOT</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap2/">protostar详细解析 heap2 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap1/">protostar详细解析 heap1 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/栈溢出练习小结/">wargame简单入门</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 mrh
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 21;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71141416-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>

  </div>
</body>
</html>