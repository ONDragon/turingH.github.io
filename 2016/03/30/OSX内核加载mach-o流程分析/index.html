<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OSX内核加载mach-o流程分析 | mrh的学习分享</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 摘要​    研究OS X安全方面的知识需要对mach-o加载的流程需要有一个比较完整的理解，断断续续一个月的时间里面，通过对源码的阅读对mach-o的加载有一个比较基本的认识，在遇到各个具体的问题是才能更好的理解和操作。
​    其他相关文章可以看这里，基本涵盖了从内核态到应用层的相关源码的简单分析。还有不足之处在遇到相关的问题时也会加到这一系列文章中。
​    1.mach-o加">
<meta property="og:type" content="article">
<meta property="og:title" content="OSX内核加载mach-o流程分析">
<meta property="og:url" content="http://turingh.github.io/2016/03/30/OSX内核加载mach-o流程分析/index.html">
<meta property="og:site_name" content="mrh的学习分享">
<meta property="og:description" content="0x00 摘要​    研究OS X安全方面的知识需要对mach-o加载的流程需要有一个比较完整的理解，断断续续一个月的时间里面，通过对源码的阅读对mach-o的加载有一个比较基本的认识，在遇到各个具体的问题是才能更好的理解和操作。
​    其他相关文章可以看这里，基本涵盖了从内核态到应用层的相关源码的简单分析。还有不足之处在遇到相关的问题时也会加到这一系列文章中。
​    1.mach-o加">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png">
<meta property="og:updated_time" content="2016-03-31T15:39:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OSX内核加载mach-o流程分析">
<meta name="twitter:description" content="0x00 摘要​    研究OS X安全方面的知识需要对mach-o加载的流程需要有一个比较完整的理解，断断续续一个月的时间里面，通过对源码的阅读对mach-o的加载有一个比较基本的认识，在遇到各个具体的问题是才能更好的理解和操作。
​    其他相关文章可以看这里，基本涵盖了从内核态到应用层的相关源码的简单分析。还有不足之处在遇到相关的问题时也会加到这一系列文章中。
​    1.mach-o加">
  
    <link rel="alternative" href="/atom.xml" title="mrh的学习分享" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/touxiang.jpeg">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">mrh</a></h1>
        </hgroup>

        
        <p class="header-subtitle">胸口写一个勇字</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">所有文章</a></li>
                        
                            <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                        
                            <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                            
                                <a class="fl twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                            
                                <a class="fl facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/CVE/" style="font-size: 14px;">CVE</a> <a href="/tags/DWORDSHOOT/" style="font-size: 10px;">DWORDSHOOT</a> <a href="/tags/OS-X/" style="font-size: 14px;">OS X</a> <a href="/tags/OSX/" style="font-size: 12px;">OSX</a> <a href="/tags/bounds-checking/" style="font-size: 10px;">bounds checking</a> <a href="/tags/dlopen/" style="font-size: 10px;">dlopen</a> <a href="/tags/dns/" style="font-size: 12px;">dns</a> <a href="/tags/dos/" style="font-size: 10px;">dos</a> <a href="/tags/dyld/" style="font-size: 18px;">dyld</a> <a href="/tags/dynamic-link/" style="font-size: 10px;">dynamic link</a> <a href="/tags/execv/" style="font-size: 12px;">execv</a> <a href="/tags/execve/" style="font-size: 10px;">execve</a> <a href="/tags/exploit/" style="font-size: 20px;">exploit</a> <a href="/tags/frame-faking/" style="font-size: 10px;">frame-faking</a> <a href="/tags/free/" style="font-size: 10px;">free</a> <a href="/tags/freebsd/" style="font-size: 10px;">freebsd</a> <a href="/tags/gethostbyname/" style="font-size: 12px;">gethostbyname</a> <a href="/tags/glibc/" style="font-size: 12px;">glibc</a> <a href="/tags/heap/" style="font-size: 18px;">heap</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/kernel/" style="font-size: 16px;">kernel</a> <a href="/tags/kextload/" style="font-size: 10px;">kextload</a> <a href="/tags/level02/" style="font-size: 10px;">level02</a> <a href="/tags/linux/" style="font-size: 12px;">linux</a> <a href="/tags/mach-o/" style="font-size: 20px;">mach-o</a> <a href="/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/osx/" style="font-size: 18px;">osx</a> <a href="/tags/patch/" style="font-size: 10px;">patch</a> <a href="/tags/ports/" style="font-size: 12px;">ports</a> <a href="/tags/race/" style="font-size: 12px;">race</a> <a href="/tags/sandbox/" style="font-size: 10px;">sandbox</a> <a href="/tags/stack/" style="font-size: 14px;">stack</a> <a href="/tags/stackoverflow/" style="font-size: 12px;">stackoverflow</a> <a href="/tags/unlink/" style="font-size: 10px;">unlink</a> <a href="/tags/wargame/" style="font-size: 12px;">wargame</a> <a href="/tags/基本功要扎实/" style="font-size: 10px;">基本功要扎实</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">啥也不说了，先干黄旭东</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">mrh</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">mrh</a></h1>
            </hgroup>
            
            <p class="header-subtitle">胸口写一个勇字</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">所有文章</a></li>
                
                    <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                
                    <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                    
                        <a class="twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                    
                        <a class="facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-OSX内核加载mach-o流程分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/30/OSX内核加载mach-o流程分析/" class="article-date">
      <time datetime="2016-03-30T23:58:05.000Z" itemprop="datePublished">2016-03-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OSX内核加载mach-o流程分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/OS-X/">OS X</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OSX/">OSX</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/execve/">execve</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mach-o/">mach-o</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="0x00_摘要">0x00 摘要</h1><p>​    研究<code>OS X</code>安全方面的知识需要对<code>mach-o</code>加载的流程需要有一个比较完整的理解，断断续续一个月的时间里面，通过对源码的阅读对<code>mach-o</code>的加载有一个比较基本的认识，在遇到各个具体的问题是才能更好的理解和操作。</p>
<p>​    其他相关文章可以看这里，基本涵盖了从内核态到应用层的相关源码的简单分析。还有不足之处在遇到相关的问题时也会加到这一系列文章中。</p>
<p>​    1.<a href="http://turingh.github.io/2016/03/01/dyld%E4%B8%ADmacho%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">mach-o加载流程学习-dyld对主image的处理流程</a></p>
<p>​    2.<a href="http://turingh.github.io/2016/03/16/dyld%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90load/">mach-o加载流程学习-dyld对依赖库的加载流程</a></p>
<p>​    3.mach-o加载流程学习-内核对mach-o文件的加载流程(本文)</p>
<p>​    </p>
<p>​    通过一张图片，可以比较清楚的理解整个流程。</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="整体流程"></p>
<a id="more"></a>
<h1 id="0x01_源码分析">0x01 源码分析</h1><h2 id="1-1___mac_execve">1.1 __mac_execve</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">__mac_execve(<span class="keyword">proc_t</span> p, <span class="keyword">struct</span> __mac_execve_args *uap, <span class="keyword">int32_t</span> *retval)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *bufp = <span class="literal">NULL</span>; </span><br><span class="line">	<span class="keyword">struct</span> image_params *imgp;</span><br><span class="line">	<span class="keyword">struct</span> vnode_attr *vap;</span><br><span class="line">	<span class="keyword">struct</span> vnode_attr *origvap;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">int</span> is_64 = IS_64BIT_PROCESS(p);</span><br><span class="line">	<span class="keyword">struct</span> vfs_context context;</span><br><span class="line">	<span class="keyword">struct</span> uthread	*uthread;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">//初始化context</span></span><br><span class="line">	context.vc_thread = current_thread();</span><br><span class="line">	context.vc_ucred = kauth_cred_proc_ref(p);	<span class="comment">/* <span class="label">XXX must NOT be kauth_cred_get() */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate a big chunk for locals instead of using stack since these  </span><br><span class="line">	 * structures a pretty big.</span><br><span class="line">	 */</span></span><br><span class="line">  	//申请一块连续的大内存，用来存放imgp，vap，origvap的数据结构</span><br><span class="line">	MALLOC(bufp, char *, (sizeof(*imgp) + sizeof(*vap) + sizeof(*origvap)), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">	imgp = (struct image_params *) bufp;</span><br><span class="line">	if (bufp == NULL) &#123;</span><br><span class="line">		error = ENOMEM</span><br><span class="line">		goto exit_with_error;</span><br><span class="line">	&#125;</span><br><span class="line">  	//通过数据结构size的偏移，指向对应的内存空间</span><br><span class="line">  	//imgp,vap,origvap实际是连续的一块内存</span><br><span class="line">	vap = (struct vnode_attr *) (bufp + sizeof(*imgp));</span><br><span class="line">	origvap = (struct vnode_attr *) (bufp + sizeof(*imgp) + sizeof(*vap));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Initialize the common data in the image_params structure */</span></span><br><span class="line">	//初始化数据</span><br><span class="line">  	imgp-&gt;ip_user_fname = uap-&gt;fname;</span><br><span class="line">	imgp-&gt;ip_user_argv = uap-&gt;argp;</span><br><span class="line">	imgp-&gt;ip_user_envv = uap-&gt;envp;</span><br><span class="line">	imgp-&gt;ip_vattr = vap;</span><br><span class="line">	imgp-&gt;ip_origvattr = origvap;</span><br><span class="line">	imgp-&gt;ip_vfs_context = &amp;context;</span><br><span class="line">	imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</span><br><span class="line">	imgp-&gt;ip_seg = (is_64 ? UIO_USERSPACE64 : UIO_USERSPACE32);</span><br><span class="line">	imgp-&gt;ip_mac_return = 0;</span><br><span class="line"></span><br><span class="line">  	//设置线程信息</span><br><span class="line">	uthread = get_bsdthread_info(current_thread());</span><br><span class="line">	if (uthread-&gt;uu_flag &amp; UT_VFORK) &#123;</span><br><span class="line">		imgp-&gt;ip_flags |= IMGPF_VFORK_EXEC;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	//MAC模块相应的处理，与进程的权限相关</span><br><span class="line">  	//MAC:https://www.freebsd.org/doc/handbook/mac.html</span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">	if (uap-&gt;mac_p != USER_ADDR_NULL) &#123;</span><br><span class="line">		error = mac_execve_enter(uap-&gt;mac_p, imgp);</span><br><span class="line">		if (error) &#123;</span><br><span class="line">			kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line">			goto exit_with_error;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">#endif</span><br><span class="line">	</span><br><span class="line">  	//执行image</span><br><span class="line">	error = exec_activate_image(imgp);</span><br><span class="line"></span><br><span class="line">  	//释放资源与出错处理</span><br><span class="line">	kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Image not claimed by any activator? */</span></span><br><span class="line">	if (error == -1)</span><br><span class="line">		error = ENOEXEC;</span><br><span class="line">	<span class="comment">/*...*/</span>	</span><br><span class="line">	return(error);</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>主要就是进行了一些数据结构的初始化已经权限的判断，资源的获取与释放，主要逻辑在<code>exec_activate_image</code>中。</p>
<h2 id="1-2_exec_activate_image">1.2 exec_activate_image</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * exec_activate_image</span><br><span class="line"> *</span><br><span class="line"> * Description:	Iterate through the available image activators, and activate</span><br><span class="line"> *		the image associated with the imgp structure.  We start with</span><br><span class="line"> *		the</span><br><span class="line"> *</span><br><span class="line"> * Parameters:	struct image_params *	Image parameter block</span><br><span class="line"> *</span><br><span class="line"> * Returns:	0			Success</span><br><span class="line"> *		EBADEXEC		The executable is corrupt/unknown</span><br><span class="line"> *	execargs_alloc:EINVAL		Invalid argument</span><br><span class="line"> *	execargs_alloc:EACCES		Permission denied</span><br><span class="line"> *	execargs_alloc:EINTR		Interrupted function</span><br><span class="line"> *	execargs_alloc:ENOMEM		Not enough space</span><br><span class="line"> *	exec_save_path:EFAULT		Bad address</span><br><span class="line"> *	exec_save_path:ENAMETOOLONG	Filename too long</span><br><span class="line"> *	exec_check_permissions:EACCES	Permission denied</span><br><span class="line"> *	exec_check_permissions:ENOEXEC	Executable file format error</span><br><span class="line"> *	exec_check_permissions:ETXTBSY	Text file busy [misuse of error code]</span><br><span class="line"> *	exec_check_permissions:???</span><br><span class="line"> *	namei:???</span><br><span class="line"> *	vn_rdwr:???			[anything vn_rdwr can return]</span><br><span class="line"> *	&lt;ex_imgact&gt;:???			[anything an imgact can return]</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> nameidata *ndp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *excpath;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">int</span> resid;</span><br><span class="line">	<span class="keyword">int</span> once = <span class="number">1</span>;	<span class="comment">/* save SGUID-ness for interpreted files */</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> itercount = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">proc_t</span> p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">	error = execargs_alloc(imgp);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	</span><br><span class="line">	error = exec_save_path(imgp, imgp-&gt;ip_user_fname, imgp-&gt;ip_seg, &amp;excpath);</span><br><span class="line">	<span class="keyword">if</span> (error) &#123;</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Use excpath, which contains the copyin-ed exec path */</span></span><br><span class="line">	DTRACE_PROC1(exec, <span class="keyword">uintptr_t</span>, excpath);</span><br><span class="line"></span><br><span class="line">	MALLOC(ndp, <span class="keyword">struct</span> nameidata *, <span class="keyword">sizeof</span>(*ndp), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">	<span class="keyword">if</span> (ndp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error = ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF | AUDITVNPATH1,</span><br><span class="line">		   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">	error = namei(ndp); <span class="comment">//<span class="doctag">todo:</span>	详细流程先不看，研究下来感觉是路径的搜索</span></span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	imgp-&gt;ip_ndp = ndp;	<span class="comment">/* successful namei(); call nameidone() later */</span></span><br><span class="line">	imgp-&gt;ip_vp = ndp-&gt;ni_vp;	<span class="comment">/* if set, need to vnode_put() at some point */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Before we start the transition from binary A to binary B, make</span><br><span class="line">	 * sure another thread hasn't started exiting the process.  We grab</span><br><span class="line">	 * the proc lock to check p_lflag initially, and the transition</span><br><span class="line">	 * mechanism ensures that the value doesn't change after we release</span><br><span class="line">	 * the lock.</span><br><span class="line">	 */</span></span><br><span class="line">	proc_lock(p);</span><br><span class="line">	<span class="keyword">if</span> (p-&gt;p_lflag &amp; P_LEXIT) &#123;</span><br><span class="line">		proc_unlock(p);</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line">	error = proc_transstart(p, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	proc_unlock(p);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line"></span><br><span class="line">	error = exec_check_permissions(imgp);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy; avoid invocation of an interpreter overwriting the original */</span></span><br><span class="line">	<span class="keyword">if</span> (once) &#123;</span><br><span class="line">		once = <span class="number">0</span>;</span><br><span class="line">		*imgp-&gt;ip_origvattr = *imgp-&gt;ip_vattr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//读取数据到内存中</span></span><br><span class="line">	error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</span><br><span class="line">			UIO_SYSSPACE, IO_NODELOCKED,</span><br><span class="line">			vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">			&amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (resid) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(imgp-&gt;ip_vdata + (PAGE_SIZE - resid), <span class="number">0x0</span>, resid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//到这里之前的代码主要做了两件事情</span></span><br><span class="line">  	<span class="comment">//1.根据路径查找文件</span></span><br><span class="line">  	<span class="comment">//2.将文件拷贝到内存中</span></span><br><span class="line">encapsulated_binary:</span><br><span class="line">	<span class="comment">/* Limit the number of iterations we will attempt on each binary */</span></span><br><span class="line">	<span class="keyword">if</span> (++itercount &gt; EAI_ITERLIMIT) &#123;</span><br><span class="line">		error = EBADEXEC;</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line">	&#125;</span><br><span class="line">	error = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; error == -<span class="number">1</span> &amp;&amp; execsw[i].ex_imgact != <span class="literal">NULL</span>; i++) &#123;</span><br><span class="line">		<span class="comment">//这里对macho文件进行了解析</span></span><br><span class="line">		error = (*execsw[i].ex_imgact)(imgp);	<span class="comment">//<span class="doctag">todo:</span>调用了一个指针函数，exec_mach_imgact</span></span><br><span class="line">      	<span class="comment">//总共有三种函数</span></span><br><span class="line">      	<span class="comment">/*</span><br><span class="line">        struct execsw &#123;</span><br><span class="line">		int (*ex_imgact)(struct image_params *);</span><br><span class="line">		const char *ex_name;</span><br><span class="line">		&#125; execsw[] = &#123;</span><br><span class="line">		&#123; exec_mach_imgact,		"Mach-o Binary" &#125;,</span><br><span class="line">		&#123; exec_fat_imgact,		"Fat Binary" &#125;,</span><br><span class="line">		&#123; exec_shell_imgact,		"Interpreter Script" &#125;,</span><br><span class="line">		&#123; NULL, NULL&#125;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span></span><br><span class="line">      	<span class="comment">//分别是osx支持的三种不同的可执行文件</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (error) &#123;</span><br><span class="line">            <span class="comment">/*出错处理*/</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Call out to allow 3rd party notification of exec. </span><br><span class="line">	 * Ignore result of kauth_authorize_fileop call.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> &amp;&amp; kauth_authorize_fileop_has_listeners()) &#123;</span><br><span class="line">		kauth_authorize_fileop(vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">					KAUTH_FILEOP_EXEC,</span><br><span class="line">					(<span class="keyword">uintptr_t</span>)ndp-&gt;ni_vp, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	proc_transend(p, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">bad_notrans:</span><br><span class="line">	<span class="keyword">if</span> (imgp-&gt;ip_strings)</span><br><span class="line">		execargs_free(imgp);</span><br><span class="line">	<span class="keyword">if</span> (imgp-&gt;ip_ndp)</span><br><span class="line">		nameidone(imgp-&gt;ip_ndp);</span><br><span class="line">	<span class="keyword">if</span> (ndp)</span><br><span class="line">		FREE(ndp, M_TEMP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数主要做的事情就是寻找并拷贝<strong>可执行文件</strong>到内存中，并且根据可执行文件的类型调用不同的解析函数。osx总共支持三种可执行文件。他们各自有对应的处理函数。</p>
<ul>
<li><a href="http://turingh.github.io/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">mach-o</a>：exec_mach_imgact</li>
<li><a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6" target="_blank" rel="external">Fat Binary</a>：exec_fat_imgact</li>
<li>Interpreter Script：exec_shell_imgact</li>
</ul>
<h2 id="1-3_exec_mach_imgact">1.3 exec_mach_imgact</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * exec_mach_imgact</span><br><span class="line"> *</span><br><span class="line"> * Image activator for mach-o 1.0 binaries.</span><br><span class="line"> *</span><br><span class="line"> * Parameters;	struct image_params *	image parameter block</span><br><span class="line"> *</span><br><span class="line"> * Returns:	-1			not a fat binary (keep looking)</span><br><span class="line"> *		-2			Success: encapsulated binary: reread</span><br><span class="line"> *		&gt;0			Failure: error number</span><br><span class="line"> *		EBADARCH		Mach-o binary, but with an unrecognized</span><br><span class="line"> *					architecture</span><br><span class="line"> *		ENOMEM			No memory for child process after -</span><br><span class="line"> *					can only happen after vfork()</span><br><span class="line"> *</span><br><span class="line"> * Important:	This image activator is NOT byte order neutral.</span><br><span class="line"> *</span><br><span class="line"> * Note:	A return value other than -1 indicates subsequent image</span><br><span class="line"> *		activators should not be given the opportunity to attempt</span><br><span class="line"> *		to activate the image.</span><br><span class="line"> *</span><br><span class="line"> * TODO:	More gracefully handle failures after vfork</span><br><span class="line"> */</span><br><span class="line">static int</span><br><span class="line">exec_mach_imgact(struct image_params *imgp)</span><br><span class="line">&#123;</span><br><span class="line">	struct mach_header *mach_header = (struct mach_header *)imgp-&gt;ip_vdata;</span><br><span class="line">	proc_t			p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line">	int			error = 0;</span><br><span class="line">	task_t			task;</span><br><span class="line">	task_t			new_task = NULL; /* protected by vfexec */</span><br><span class="line">	thread_t		thread;</span><br><span class="line">	struct uthread		*uthread;</span><br><span class="line">	vm_map_t old_map = VM_MAP_NULL;</span><br><span class="line">	vm_map_t map;</span><br><span class="line">	load_return_t		lret;</span><br><span class="line">	load_result_t		load_result;</span><br><span class="line">	struct _posix_spawnattr *psa = NULL;</span><br><span class="line">	int			spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</span><br><span class="line">	int			vfexec = (imgp-&gt;ip_flags &amp; IMGPF_VFORK_EXEC);</span><br><span class="line">	int			p_name_len;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * make sure it's a Mach-O 1.0 or Mach-O 2.0 binary; the difference</span><br><span class="line">	 * is a reserved field on the end, so for the most part, we can</span><br><span class="line">	 * treat them as if they were identical. Reverse-endian Mach-O</span><br><span class="line">	 * binaries are recognized but not compatible.</span><br><span class="line"> 	 */</span><br><span class="line">    // 检测header里面的magic，是否符合macho文件的特征</span><br><span class="line">  	// NXSwapInt:PowerPC等平台中的二进制文件</span><br><span class="line">  	//MH_CIGAM    = 0xCEFAEDFE</span><br><span class="line">    //MH_CIGAM_64 = 0xCFFAEDFE</span><br><span class="line">	if ((mach_header-&gt;magic == MH_CIGAM) ||</span><br><span class="line">	    (mach_header-&gt;magic == MH_CIGAM_64)) &#123;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	// 检测header里面的magic，是否符合macho文件的特征</span><br><span class="line">    // #define	MH_MAGIC	0xfeedface</span><br><span class="line">  	// #define MH_MAGIC_64 0xfeedfacf </span><br><span class="line">    // 通用的macho二进制文件，一般遇到都是这种</span><br><span class="line">	if ((mach_header-&gt;magic != MH_MAGIC) &amp;&amp;</span><br><span class="line">	    (mach_header-&gt;magic != MH_MAGIC_64)) &#123;</span><br><span class="line">		error = -1;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  	// 检测macho的文件类型，文件类型必须是可执行文件</span><br><span class="line">   	// 还有一些其他的常见类型</span><br><span class="line">    // #define	MH_OBJECT	0x1		编译过程产生的obj文件</span><br><span class="line">    // #define	MH_CORE		0x4		崩溃时的dump文件</span><br><span class="line">	if (mach_header-&gt;filetype != MH_EXECUTE) &#123;</span><br><span class="line">		error = -1;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    // 获取macho的执行环境，cpu的平台与版本</span><br><span class="line">	if (imgp-&gt;ip_origcputype != 0) &#123;</span><br><span class="line">		/* Fat header previously had an idea about this thin file */</span><br><span class="line">		if (imgp-&gt;ip_origcputype != mach_header-&gt;cputype ||</span><br><span class="line">			imgp-&gt;ip_origcpusubtype != mach_header-&gt;cpusubtype) &#123;</span><br><span class="line">			error = EBADARCH;</span><br><span class="line">			goto bad;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		imgp-&gt;ip_origcputype = mach_header-&gt;cputype;</span><br><span class="line">		imgp-&gt;ip_origcpusubtype = mach_header-&gt;cpusubtype;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	task = current_task();</span><br><span class="line">	thread = current_thread();</span><br><span class="line">	uthread = get_bsdthread_info(thread);</span><br><span class="line"></span><br><span class="line">	if ((mach_header-&gt;cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64)</span><br><span class="line">		imgp-&gt;ip_flags |= IMGPF_IS_64BIT;</span><br><span class="line"></span><br><span class="line">	/* If posix_spawn binprefs exist, respect those prefs. */</span><br><span class="line">	psa = (struct _posix_spawnattr *) imgp-&gt;ip_px_sa;</span><br><span class="line">	if (psa != NULL &amp;&amp; psa-&gt;psa_binprefs[0] != 0) &#123;</span><br><span class="line">		int pr = 0;</span><br><span class="line">		for (pr = 0; pr &lt; NBINPREFS; pr++) &#123;</span><br><span class="line">			cpu_type_t pref = psa-&gt;psa_binprefs[pr];</span><br><span class="line">			if (pref == 0) &#123;</span><br><span class="line">				/* No suitable arch in the pref list */</span><br><span class="line">				error = EBADARCH;</span><br><span class="line">				goto bad;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (pref == CPU_TYPE_ANY) &#123;</span><br><span class="line">				/* Jump to regular grading */</span><br><span class="line">				goto grade;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (pref == imgp-&gt;ip_origcputype) &#123;</span><br><span class="line">				/* We have a match! */</span><br><span class="line">				goto grade;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line">grade:</span><br><span class="line">  	//检测cpu平台</span><br><span class="line">	if (!grade_binary(imgp-&gt;ip_origcputype, imgp-&gt;ip_origcpusubtype &amp; ~CPU_SUBTYPE_MASK)) 	  &#123;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Copy in arguments/environment from the old process */</span><br><span class="line">    //获取环境变量和参数</span><br><span class="line">    //为vfork执行macho做准备</span><br><span class="line">	error = exec_extract_strings(imgp);</span><br><span class="line">	if (error)</span><br><span class="line">		goto bad;</span><br><span class="line"></span><br><span class="line">	error = exec_add_apple_strings(imgp);</span><br><span class="line">	if (error)</span><br><span class="line">		goto bad;</span><br><span class="line"></span><br><span class="line">	AUDIT_ARG(argv, imgp-&gt;ip_startargv, imgp-&gt;ip_argc, </span><br><span class="line">	    imgp-&gt;ip_endargv - imgp-&gt;ip_startargv);</span><br><span class="line">	AUDIT_ARG(envv, imgp-&gt;ip_endargv, imgp-&gt;ip_envc,</span><br><span class="line">	    imgp-&gt;ip_endenvv - imgp-&gt;ip_endargv);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We are being called to activate an image subsequent to a vfork()</span><br><span class="line">	 * operation; in this case, we know that our task, thread, and</span><br><span class="line">	 * uthread are actually those of our parent, and our proc, which we</span><br><span class="line">	 * obtained indirectly from the image_params vfs_context_t, is the</span><br><span class="line">	 * new child process.</span><br><span class="line">	 */</span><br><span class="line">    // 通过fork，为macho生成一个新的线程</span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		if (vfexec) &#123;</span><br><span class="line">			imgp-&gt;ip_new_thread = fork_create_child(task, NULL, p, FALSE, (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT));</span><br><span class="line">			if (imgp-&gt;ip_new_thread == NULL) &#123;</span><br><span class="line">				error = ENOMEM;</span><br><span class="line">				goto bad;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* reset local idea of thread, uthread, task */</span><br><span class="line">		thread = imgp-&gt;ip_new_thread;</span><br><span class="line">		uthread = get_bsdthread_info(thread);</span><br><span class="line">		task = new_task = get_threadtask(thread);</span><br><span class="line">		map = get_task_map(task);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		map = VM_MAP_NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We set these flags here; this is OK, since if we fail after</span><br><span class="line">	 * this point, we have already destroyed the parent process anyway.</span><br><span class="line">	 */</span><br><span class="line">    // 设置一些dyld需要使用的参数</span><br><span class="line">	task_set_dyld_info(task, MACH_VM_MIN_ADDRESS, 0);</span><br><span class="line">	if (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) &#123;</span><br><span class="line">		task_set_64bit(task, TRUE);</span><br><span class="line">		OSBitOrAtomic(P_LP64, &amp;p-&gt;p_flag);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		task_set_64bit(task, FALSE);</span><br><span class="line">		OSBitAndAtomic(~((uint32_t)P_LP64), &amp;p-&gt;p_flag);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 *	Load the Mach-O file.</span><br><span class="line">	 *</span><br><span class="line">	 * NOTE: An error after this point  indicates we have potentially</span><br><span class="line">	 * destroyed or overwritten some process state while attempting an</span><br><span class="line">	 * execve() following a vfork(), which is an unrecoverable condition.</span><br><span class="line">	 * We send the new process an immediate SIGKILL to avoid it executing</span><br><span class="line">	 * any instructions in the mutated address space. For true spawns,</span><br><span class="line">	 * this is not the case, and "too late" is still not too late to</span><br><span class="line">	 * return an error code to the parent process.</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Actually load the image file we previously decided to load.</span><br><span class="line">	 */</span><br><span class="line">    //加载，映射macho文件到内存</span><br><span class="line">	lret = load_machfile(imgp, mach_header, thread, map, &amp;load_result);</span><br><span class="line"></span><br><span class="line">	if (lret != LOAD_SUCCESS) &#123;</span><br><span class="line">		error = load_return_to_errno(lret);</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proc_lock(p);</span><br><span class="line">	p-&gt;p_cputype = imgp-&gt;ip_origcputype;</span><br><span class="line">	p-&gt;p_cpusubtype = imgp-&gt;ip_origcpusubtype;</span><br><span class="line">	proc_unlock(p);</span><br><span class="line"></span><br><span class="line">	vm_map_set_user_wire_limit(get_task_map(task), p-&gt;p_rlimit[RLIMIT_MEMLOCK].rlim_cur);</span><br><span class="line"></span><br><span class="line">	/* </span><br><span class="line">	 * Set code-signing flags if this binary is signed, or if parent has</span><br><span class="line">	 * requested them on exec.</span><br><span class="line">	 */</span><br><span class="line">  	//设置了一堆标记位</span><br><span class="line">    //需要关心一下的是这里和code-signgin有点关系</span><br><span class="line">	if (load_result.csflags &amp; CS_VALID) &#123;</span><br><span class="line">		imgp-&gt;ip_csflags |= load_result.csflags &amp; </span><br><span class="line">			(CS_VALID|</span><br><span class="line">			 CS_HARD|CS_KILL|CS_RESTRICT|CS_ENFORCEMENT|CS_REQUIRE_LV|CS_DYLD_PLATFORM|</span><br><span class="line">			 CS_EXEC_SET_HARD|CS_EXEC_SET_KILL|CS_EXEC_SET_ENFORCEMENT);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		imgp-&gt;ip_csflags &amp;= ~CS_VALID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_HARD)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_HARD;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_KILL)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_KILL;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_ENFORCEMENT)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_ENFORCEMENT;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_INSTALLER)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_INSTALLER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Set up the system reserved areas in the new address space.</span><br><span class="line">	 */</span><br><span class="line">    //依据可执行文件的平台，设置合适的执行环境</span><br><span class="line">	vm_map_exec(get_task_map(task),</span><br><span class="line">		    task,</span><br><span class="line">		    (void *) p-&gt;p_fd-&gt;fd_rdir,</span><br><span class="line">		    cpu_type());</span><br><span class="line">	</span><br><span class="line">	/*</span><br><span class="line">	 * Close file descriptors which specify close-on-exec.</span><br><span class="line">	 */</span><br><span class="line">    //关闭所有被标记为close-on-exec的文件</span><br><span class="line">	fdexec(p, psa != NULL ? psa-&gt;psa_flags : 0);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * deal with set[ug]id.</span><br><span class="line">	 */</span><br><span class="line">  	//处理setuid相关的逻辑，和权限相关</span><br><span class="line">	error = exec_handle_sugid(imgp);</span><br><span class="line">	if (error) &#123;</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * deal with voucher on exec-calling thread.</span><br><span class="line">	 */</span><br><span class="line">	if (imgp-&gt;ip_new_thread == NULL)</span><br><span class="line">		thread_set_mach_voucher(current_thread(), IPC_VOUCHER_NULL);</span><br><span class="line"></span><br><span class="line">	/* Make sure we won't interrupt ourself signalling a partial process */</span><br><span class="line">	if (!vfexec &amp;&amp; !spawn &amp;&amp; (p-&gt;p_lflag &amp; P_LTRACED))</span><br><span class="line">		psignal(p, SIGTRAP);</span><br><span class="line">	</span><br><span class="line">  	//为进程设置应用层的栈地址</span><br><span class="line">	if (load_result.unixproc &amp;&amp;</span><br><span class="line">		create_unix_stack(get_task_map(task),</span><br><span class="line">				  &amp;load_result,</span><br><span class="line">				  p) != KERN_SUCCESS) &#123;</span><br><span class="line">		error = load_return_to_errno(LOAD_NOSPACE);</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		old_map = vm_map_switch(get_task_map(task));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (load_result.unixproc) &#123;</span><br><span class="line">		user_addr_t	ap;</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">		 * Copy the strings area out into the new process address</span><br><span class="line">		 * space.</span><br><span class="line">		 */</span><br><span class="line">		ap = p-&gt;user_stack;</span><br><span class="line">		error = exec_copyout_strings(imgp, &amp;ap);</span><br><span class="line">		if (error) &#123;</span><br><span class="line">			if (vfexec || spawn)</span><br><span class="line">				vm_map_switch(old_map);</span><br><span class="line">			goto badtoolate;</span><br><span class="line">		&#125;</span><br><span class="line">		/* Set the stack */</span><br><span class="line">		thread_setuserstack(thread, ap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	if (load_result.dynlinker) &#123;</span><br><span class="line">		uint64_t	ap;</span><br><span class="line">		int			new_ptr_size = (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) ? 8 : 4;</span><br><span class="line"></span><br><span class="line">		/* Adjust the stack */</span><br><span class="line">		ap = thread_adjuserstack(thread, -new_ptr_size);</span><br><span class="line">		error = copyoutptr(load_result.mach_header, ap, new_ptr_size);</span><br><span class="line"></span><br><span class="line">		if (error) &#123;</span><br><span class="line">			if (vfexec || spawn)</span><br><span class="line">				vm_map_switch(old_map);</span><br><span class="line">			goto badtoolate;</span><br><span class="line">		&#125;</span><br><span class="line">		task_set_dyld_info(task, load_result.all_image_info_addr,</span><br><span class="line">		    load_result.all_image_info_size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Avoid immediate VM faults back into kernel */</span><br><span class="line">  	//防止立刻执行指令导致的错误，做了大量和dyld相关的事情</span><br><span class="line">	exec_prefault_data(p, imgp, &amp;load_result);</span><br><span class="line"></span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		vm_map_switch(old_map);</span><br><span class="line">	&#125;</span><br><span class="line">	/* Set the entry point */</span><br><span class="line">	thread_setentrypoint(thread, load_result.entry_point);</span><br><span class="line"></span><br><span class="line">	/* Stop profiling */</span><br><span class="line">	stopprofclock(p);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Reset signal state.</span><br><span class="line">	 */</span><br><span class="line">	execsigs(p, thread);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * need to cancel async IO requests that can be cancelled and wait for those</span><br><span class="line">	 * already active.  MAY BLOCK!</span><br><span class="line">	 */</span><br><span class="line">	_aio_exec( p );</span><br><span class="line"></span><br><span class="line">#if SYSV_SHM</span><br><span class="line">	/* FIXME: Till vmspace inherit is fixed: */</span><br><span class="line">	if (!vfexec &amp;&amp; p-&gt;vm_shm)</span><br><span class="line">		shmexec(p);</span><br><span class="line">#endif</span><br><span class="line">#if SYSV_SEM</span><br><span class="line">	/* Clean up the semaphores */</span><br><span class="line">	semexit(p);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Remember file name for accounting.</span><br><span class="line">	 */</span><br><span class="line">	p-&gt;p_acflag &amp;= ~AFORK;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Set p-&gt;p_comm and p-&gt;p_name to the name passed to exec</span><br><span class="line">	 */</span><br><span class="line">	p_name_len = sizeof(p-&gt;p_name) - 1;</span><br><span class="line">	if(imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen &gt; p_name_len)</span><br><span class="line">		imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen = p_name_len;</span><br><span class="line">	bcopy((caddr_t)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_nameptr, (caddr_t)p-&gt;p_name,</span><br><span class="line">		(unsigned)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen);</span><br><span class="line">	p-&gt;p_name[imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen] = '\0';</span><br><span class="line"></span><br><span class="line">	if (imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen &gt; MAXCOMLEN)</span><br><span class="line">		imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen = MAXCOMLEN;</span><br><span class="line">	bcopy((caddr_t)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_nameptr, (caddr_t)p-&gt;p_comm,</span><br><span class="line">		(unsigned)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen);</span><br><span class="line">	p-&gt;p_comm[imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen] = '\0';</span><br><span class="line"></span><br><span class="line">	pal_dbg_set_task_name( p-&gt;task );</span><br><span class="line"></span><br><span class="line">#if DEVELOPMENT || DEBUG</span><br><span class="line">	/* </span><br><span class="line">	 * Update the pid an proc name for importance base if any</span><br><span class="line">	 */</span><br><span class="line">	task_importance_update_owner_info(p-&gt;task);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	memcpy(&amp;p-&gt;p_uuid[0], &amp;load_result.uuid[0], sizeof(p-&gt;p_uuid));</span><br><span class="line"></span><br><span class="line">// &lt;rdar://6598155&gt; dtrace code cleanup needed</span><br><span class="line">#if CONFIG_DTRACE</span><br><span class="line">	/*</span><br><span class="line">	 * Invalidate any predicate evaluation already cached for this thread by DTrace.</span><br><span class="line">	 * That's because we've just stored to p_comm and DTrace refers to that when it</span><br><span class="line">	 * evaluates the "execname" special variable. uid and gid may have changed as well.</span><br><span class="line">	 */</span><br><span class="line">	dtrace_set_thread_predcache(current_thread(), 0);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Free any outstanding lazy dof entries. It is imperative we</span><br><span class="line">	 * always call dtrace_lazy_dofs_destroy, rather than null check</span><br><span class="line">	 * and call if !NULL. If we NULL test, during lazy dof faulting</span><br><span class="line">	 * we can race with the faulting code and proceed from here to</span><br><span class="line">	 * beyond the helpers cleanup. The lazy dof faulting will then</span><br><span class="line">	 * install new helpers which no longer belong to this process!</span><br><span class="line">	 */</span><br><span class="line">	dtrace_lazy_dofs_destroy(p);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">    	 * Clean up any DTrace helpers for the process.</span><br><span class="line">    	 */</span><br><span class="line">    	if (p-&gt;p_dtrace_helpers != NULL &amp;&amp; dtrace_helpers_cleanup) &#123;</span><br><span class="line">    		(*dtrace_helpers_cleanup)(p);</span><br><span class="line">    	&#125;</span><br><span class="line">	</span><br><span class="line">    	/*</span><br><span class="line">    	 * Cleanup the DTrace provider associated with this process.</span><br><span class="line">    	 */</span><br><span class="line">	proc_lock(p);</span><br><span class="line">	if (p-&gt;p_dtrace_probes &amp;&amp; dtrace_fasttrap_exec_ptr) &#123;</span><br><span class="line">		(*dtrace_fasttrap_exec_ptr)(p);</span><br><span class="line">	&#125;</span><br><span class="line">	proc_unlock(p);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (kdebug_enable) &#123;</span><br><span class="line">		long dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4;</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">		 * Collect the pathname for tracing</span><br><span class="line">		 */</span><br><span class="line">		kdbg_trace_string(p, &amp;dbg_arg1, &amp;dbg_arg2, &amp;dbg_arg3, &amp;dbg_arg4);</span><br><span class="line"></span><br><span class="line">		if (vfexec || spawn) &#123;</span><br><span class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_DATA_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					p-&gt;p_pid ,0,0,0, (uintptr_t)thread_tid(thread));</span><br><span class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_STRING_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, (uintptr_t)thread_tid(thread));</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			KERNEL_DEBUG_CONSTANT(TRACE_DATA_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					p-&gt;p_pid ,0,0,0,0);</span><br><span class="line">			KERNEL_DEBUG_CONSTANT(TRACE_STRING_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, 0);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * If posix_spawned with the START_SUSPENDED flag, stop the</span><br><span class="line">	 * process before it runs.</span><br><span class="line">	 */</span><br><span class="line">	if (imgp-&gt;ip_px_sa != NULL) &#123;</span><br><span class="line">		psa = (struct _posix_spawnattr *) imgp-&gt;ip_px_sa;</span><br><span class="line">		if (psa-&gt;psa_flags &amp; POSIX_SPAWN_START_SUSPENDED) &#123;</span><br><span class="line">			proc_lock(p);</span><br><span class="line">			p-&gt;p_stat = SSTOP;</span><br><span class="line">			proc_unlock(p);</span><br><span class="line">			(void) task_suspend_internal(p-&gt;task);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * mark as execed, wakeup the process that vforked (if any) and tell</span><br><span class="line">	 * it that it now has its own resources back</span><br><span class="line">	 */</span><br><span class="line">	OSBitOrAtomic(P_EXEC, &amp;p-&gt;p_flag);</span><br><span class="line">	proc_resetregister(p);</span><br><span class="line">	if (p-&gt;p_pptr &amp;&amp; (p-&gt;p_lflag &amp; P_LPPWAIT)) &#123;</span><br><span class="line">		proc_lock(p);</span><br><span class="line">		p-&gt;p_lflag &amp;= ~P_LPPWAIT;</span><br><span class="line">		proc_unlock(p);</span><br><span class="line">		wakeup((caddr_t)p-&gt;p_pptr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Pay for our earlier safety; deliver the delayed signals from</span><br><span class="line">	 * the incomplete vfexec process now that it's complete.</span><br><span class="line">	 */</span><br><span class="line">	if (vfexec &amp;&amp; (p-&gt;p_lflag &amp; P_LTRACED)) &#123;</span><br><span class="line">		psignal_vfork(p, new_task, thread, SIGTRAP);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	goto done;</span><br><span class="line"></span><br><span class="line">badtoolate:</span><br><span class="line">	/* Don't allow child process to execute any instructions */</span><br><span class="line">	if (!spawn) &#123;</span><br><span class="line">		if (vfexec) &#123;</span><br><span class="line">			psignal_vfork(p, new_task, thread, SIGKILL);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			psignal(p, SIGKILL);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* We can't stop this system call at this point, so just pretend we succeeded */</span><br><span class="line">		error = 0;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">done:</span><br><span class="line">	if (!spawn) &#123;</span><br><span class="line">		/* notify only if it has not failed due to FP Key error */</span><br><span class="line">		if ((p-&gt;p_lflag &amp; P_LTERM_DECRYPTFAIL) == 0)</span><br><span class="line">			proc_knote(p, NOTE_EXEC);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Drop extra references for cases where we don't expect the caller to clean up */</span><br><span class="line">	if (vfexec || (spawn &amp;&amp; error == 0)) &#123;</span><br><span class="line">		task_deallocate(new_task);</span><br><span class="line">		thread_deallocate(thread);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	return(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数主要做这几件事情：</p>
<ul>
<li>对macho文件做最基本的检测</li>
<li><code>fork</code>新的线程运行macho</li>
<li>映射macho文件到内存中</li>
<li>对setuid，code-sign等权限相关的事情有处理</li>
<li>为dyld接手macho文件的处理做了大量的准备工作</li>
<li>dyld处理完之后，对资源的释放</li>
</ul>
<h2 id="1-4_load_machfile">1.4 load_machfile</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load_return_t</span></span><br><span class="line">load_machfile(</span><br><span class="line">	<span class="keyword">struct</span> image_params	*imgp,</span><br><span class="line">	<span class="keyword">struct</span> mach_header	*header,</span><br><span class="line">	<span class="keyword">thread_t</span> 		thread,</span><br><span class="line">	<span class="keyword">vm_map_t</span> 		new_map,</span><br><span class="line">	<span class="keyword">load_result_t</span>		*result</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> vnode		*vp = imgp-&gt;ip_vp;</span><br><span class="line">	<span class="keyword">off_t</span>			file_offset = imgp-&gt;ip_arch_offset;</span><br><span class="line">	<span class="keyword">off_t</span>			macho_size = imgp-&gt;ip_arch_size;</span><br><span class="line">	<span class="keyword">off_t</span>			file_size = imgp-&gt;ip_vattr-&gt;va_data_size;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pmap_t</span>			pmap = <span class="number">0</span>;	<span class="comment">/* protected by create_map */</span></span><br><span class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>;</span><br><span class="line">	<span class="keyword">vm_map_t</span>		old_map;</span><br><span class="line">	<span class="keyword">task_t</span>			old_task = TASK_NULL; <span class="comment">/* protected by create_map */</span></span><br><span class="line">	<span class="keyword">load_result_t</span>		myresult;</span><br><span class="line">	<span class="keyword">load_return_t</span>		lret;</span><br><span class="line">	<span class="keyword">boolean_t</span> create_map = FALSE;</span><br><span class="line">	<span class="keyword">boolean_t</span> enforce_hard_pagezero = TRUE;</span><br><span class="line">	<span class="keyword">int</span> spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</span><br><span class="line">	<span class="keyword">task_t</span> task = current_task();</span><br><span class="line">	<span class="keyword">proc_t</span> p = current_proc();</span><br><span class="line">	<span class="keyword">mach_vm_offset_t</span>	aslr_offset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">mach_vm_offset_t</span>	dyld_aslr_offset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">kern_return_t</span> 		kret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (macho_size &gt; file_size) &#123;</span><br><span class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (new_map == VM_MAP_NULL) &#123;</span><br><span class="line">		create_map = TRUE;</span><br><span class="line">		old_task = current_task();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * If we are spawning, we have created backing objects for the process</span><br><span class="line">	 * already, which include non-lazily creating the task map.  So we</span><br><span class="line">	 * are going to switch out the task map with one appropriate for the</span><br><span class="line">	 * bitness of the image being loaded.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (spawn) &#123;</span><br><span class="line">		create_map = TRUE;</span><br><span class="line">		old_task = get_threadtask(thread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">//如果有new_map就用参数传进来的new_map</span></span><br><span class="line">  	<span class="comment">//否则就通过pmap_create,vm_map_create函数创建新的内存空间</span></span><br><span class="line">	<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">		<span class="keyword">task_t</span> ledger_task;</span><br><span class="line">		<span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</span><br><span class="line">			ledger_task = get_threadtask(imgp-&gt;ip_new_thread);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ledger_task = task;</span><br><span class="line">		&#125;</span><br><span class="line">		pmap = pmap_create(get_task_ledger(ledger_task),</span><br><span class="line">				   (<span class="keyword">vm_map_size_t</span>) <span class="number">0</span>,</span><br><span class="line">				   ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) != <span class="number">0</span>));</span><br><span class="line">		pal_switch_pmap(thread, pmap, imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT);</span><br><span class="line">		<span class="built_in">map</span> = vm_map_create(pmap,</span><br><span class="line">				<span class="number">0</span>,</span><br><span class="line">				vm_compute_max_offset(((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == IMGPF_IS_64BIT)),</span><br><span class="line">				TRUE);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="built_in">map</span> = new_map;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span>   (__ARM_ARCH_7K__ &gt;= <span class="number">2</span>) &amp;&amp; defined(PLATFORM_WatchOS)</span></span><br><span class="line">	<span class="comment">/* enforce 16KB alignment for watch targets with new ABI */</span></span><br><span class="line">	vm_map_set_page_shift(<span class="built_in">map</span>, SIXTEENK_PAGE_SHIFT);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span> <span class="comment">/* __arm64__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span>	CONFIG_ENFORCE_SIGNED_CODE</span></span><br><span class="line">	<span class="comment">/* This turns off faulting for executable pages, which allows</span><br><span class="line">	 * to circumvent Code Signing Enforcement. The per process</span><br><span class="line">	 * flag (CS_ENFORCEMENT) is not set yet, but we can use the</span><br><span class="line">	 * global flag.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</span><br><span class="line">	        vm_map_disable_NX(<span class="built_in">map</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Forcibly disallow execution from data pages on even if the arch</span><br><span class="line">	 * normally permits it. */</span></span><br><span class="line">  	<span class="comment">//将内存设置为不可执行，用来防止溢出漏洞的利用</span></span><br><span class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</span><br><span class="line">		vm_map_disallow_data_exec(<span class="built_in">map</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Compute a random offset for ASLR, and an independent random offset for dyld.</span><br><span class="line">	 */</span></span><br><span class="line">  	<span class="comment">//地址随机，计算ASLR的偏移量</span></span><br><span class="line">	<span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</span><br><span class="line">		<span class="keyword">uint64_t</span> max_slide_pages;</span><br><span class="line"></span><br><span class="line">		max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		aslr_offset = random();</span><br><span class="line">		aslr_offset %= max_slide_pages;</span><br><span class="line">		aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		dyld_aslr_offset = random();</span><br><span class="line">		dyld_aslr_offset %= max_slide_pages;</span><br><span class="line">		dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!result)</span><br><span class="line">		result = &amp;myresult;</span><br><span class="line"></span><br><span class="line">	*result = load_result_null;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//解析macho的文件格式</span></span><br><span class="line">	lret = parse_machfile(vp, <span class="built_in">map</span>, thread, header, file_offset, macho_size,</span><br><span class="line">	                      <span class="number">0</span>, (<span class="keyword">int64_t</span>)aslr_offset, (<span class="keyword">int64_t</span>)dyld_aslr_offset, result);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</span><br><span class="line">		<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">			vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>(lret);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * On x86, for compatibility, don't enforce the hard page-zero restriction for 32-bit binaries.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == <span class="number">0</span>) &#123;</span><br><span class="line">		enforce_hard_pagezero = FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Check to see if the page zero is enforced by the map-&gt;min_offset.</span><br><span class="line">	 */</span> </span><br><span class="line">	<span class="keyword">if</span> (enforce_hard_pagezero &amp;&amp;</span><br><span class="line">	    (vm_map_has_hard_pagezero(<span class="built_in">map</span>, <span class="number">0x1000</span>) == FALSE)) &#123;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> (LOAD_BADMACHO);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 *	Commit to new map.</span><br><span class="line">	 *</span><br><span class="line">	 *	Swap the new map for the old, which  consumes our new map</span><br><span class="line">	 *	reference but each leaves us responsible for the old_map reference.</span><br><span class="line">	 *	That lets us get off the pmap associated with it, and</span><br><span class="line">	 *	then we can release it.</span><br><span class="line">	 */</span></span><br><span class="line">	 <span class="comment">//用新申请的内存替换原来的内存</span></span><br><span class="line">	 <span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		 * If this is an exec, then we are going to destroy the old</span><br><span class="line">		 * task, and it's correct to halt it; if it's spawn, the</span><br><span class="line">		 * task is not yet running, and it makes no sense.</span><br><span class="line">		 */</span></span><br><span class="line">	 	<span class="keyword">if</span> (!spawn) &#123;</span><br><span class="line">			<span class="comment">/*</span><br><span class="line">			 * Mark the task as halting and start the other</span><br><span class="line">			 * threads towards terminating themselves.  Then</span><br><span class="line">			 * make sure any threads waiting for a process</span><br><span class="line">			 * transition get informed that we are committed to</span><br><span class="line">			 * this transition, and then finally complete the</span><br><span class="line">			 * task halting (wait for threads and then cleanup</span><br><span class="line">			 * task resources).</span><br><span class="line">			 *</span><br><span class="line">			 * <span class="doctag">NOTE:</span> task_start_halt() makes sure that no new</span><br><span class="line">			 * threads are created in the task during the transition.</span><br><span class="line">			 * We need to mark the workqueue as exiting before we</span><br><span class="line">			 * wait for threads to terminate (at the end of which</span><br><span class="line">			 * we no longer have a prohibition on thread creation).</span><br><span class="line">			 * </span><br><span class="line">			 * Finally, clean up any lingering workqueue data structures</span><br><span class="line">			 * that may have been left behind by the workqueue threads</span><br><span class="line">			 * as they exited (and then clean up the work queue itself).</span><br><span class="line">			 */</span></span><br><span class="line">			kret = task_start_halt(task);</span><br><span class="line">			<span class="keyword">if</span> (kret != KERN_SUCCESS) &#123;</span><br><span class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">				<span class="keyword">return</span> (LOAD_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			proc_transcommit(p, <span class="number">0</span>);</span><br><span class="line">			workqueue_mark_exiting(p);</span><br><span class="line">			task_complete_halt(task);</span><br><span class="line">			workqueue_exit(p);</span><br><span class="line">			kqueue_dealloc(p-&gt;p_wqkqueue);</span><br><span class="line">			p-&gt;p_wqkqueue = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		old_map = swap_task_map(old_task, thread, <span class="built_in">map</span>, !spawn);</span><br><span class="line">		vm_map_deallocate(old_map);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>(LOAD_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数主要做了<code>macho</code>文件解析之外其他所有和加载相关的工作。</p>
<ul>
<li>对新的task做了内存的分配</li>
<li>加强安全方面的设置主要是<code>DEP</code>和<code>ASRL</code></li>
<li>调用函数解析macho文件</li>
<li>解析成功之后，用新申请的内存替换旧的内存。</li>
</ul>
<h2 id="1-5_parse_machfile">1.5 parse_machfile</h2><p>这个函数做的事情就非常的简单清楚了，就是将<code>macho</code>文件解析，并且映射到内存中。</p>
<p>在我的<a href="http://turingh.github.io/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/#0x03_Load_Commands">macho文件格式分析</a>中已经分析过这一块代码了。这里就不复述了。</p>
<h1 id="0x02_小结">0x02 小结</h1><p>通过对整个流程源码的一次简单梳理，大致明白了整个流程在源码中是怎么样实现的，在研究这方面的漏洞的时候可以更快的明白问题出在哪里，也可能更深刻的理解漏洞的成因以及重现的方法。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/03/30/OSX内核加载mach-o流程分析/">OSX内核加载mach-o流程分析</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 mrh 的个人博客">mrh</a></p>
        <p><span>发布时间:</span>2016年03月30日 - 19时58分</p>
        <p><span>最后更新:</span>2016年03月31日 - 11时39分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/03/30/OSX内核加载mach-o流程分析/" title="OSX内核加载mach-o流程分析">http://turingh.github.io/2016/03/30/OSX内核加载mach-o流程分析/</a>
            <span class="copy-path" data-clipboard-text="原文: http://turingh.github.io/2016/03/30/OSX内核加载mach-o流程分析/　　作者: mrh" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2016/04/03/CVE-2016-1757简单分析/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          CVE-2016-1757简单分析
        
      </div>
    </a>
  
  
    <a href="/2016/03/22/fishhook源码分析/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">fishhook源码分析</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00_摘要"><span class="toc-number">1.</span> <span class="toc-text">0x00 摘要</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01_源码分析"><span class="toc-number">2.</span> <span class="toc-text">0x01 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1___mac_execve"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 __mac_execve</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2_exec_activate_image"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 exec_activate_image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3_exec_mach_imgact"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 exec_mach_imgact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4_load_machfile"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 load_machfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5_parse_machfile"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 parse_machfile</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02_小结"><span class="toc-number">3.</span> <span class="toc-text">0x02 小结</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>







    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/04/03/CVE-2016-1757简单分析/" title="上一篇: CVE-2016-1757简单分析">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2016/03/22/fishhook源码分析/" title="下一篇: fishhook源码分析">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/libmalloc源码分析之初始化/">libmalloc源码分析之初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/nlist-Mach-O文件重定向信息数据结构分析/">nlist-Mach-O文件重定向信息数据结构分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/10-11-4版本小结/">10-11-4版本小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/29/CVE-2016-1749内核代码执行POC分析/">CVE-2016-1749内核代码执行POC分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/CVE-2016-1757利用程序分析/">CVE-2016-1757利用程序分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/18/apple沙盒研究之基础知识/">apple沙盒研究之基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/13/利用patch绕过kextload对内核签名的检测/">利用patch绕过kextload对内核签名的检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/CVE-2016-1757简单分析/">CVE-2016-1757简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/30/OSX内核加载mach-o流程分析/">OSX内核加载mach-o流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/fishhook源码分析/">fishhook源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/dyld源码分析load/">dyld源码分析-动态加载load</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/10/Mach-O的动态链接/">Mach-O的动态链接相关知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/mach-o文件格式分析/">mach-o格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/03/CVE-2016-0799简单分析/">CVE-2016-0799简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/dyld中macho加载的简单分析/">dyld中mach-o文件加载的简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/29/OS-X-内核研究-基础知识/">OS X 内核研究 准备知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/通过fusion level02浅谈exploit中的函数调用伪造/">通过fusion level02浅谈exploit中的函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试副本/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/09/CVE-2016-1879调试&分析/">CVE-2016-1879 调试&分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/27/frame-faking/">frame-faking-介绍-函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/protostar-heap3/">protostar详细解析 heap3-通过heap3理解堆腐坏的原理及利用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/12/图解DWORDSHOOT/">图解DWORDSHOOT</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap2/">protostar详细解析 heap2 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap1/">protostar详细解析 heap1 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/栈溢出练习小结/">wargame简单入门</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 mrh
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 21;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71141416-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>

  </div>
</body>
</html>